<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Surface Runoff ¬∑ EnvironmentalTransport.jl</title><meta name="title" content="Surface Runoff ¬∑ EnvironmentalTransport.jl"/><meta property="og:title" content="Surface Runoff ¬∑ EnvironmentalTransport.jl"/><meta property="twitter:title" content="Surface Runoff ¬∑ EnvironmentalTransport.jl"/><meta name="description" content="Documentation for EnvironmentalTransport.jl."/><meta property="og:description" content="Documentation for EnvironmentalTransport.jl."/><meta property="twitter:description" content="Documentation for EnvironmentalTransport.jl."/><meta property="og:url" content="https://EarthSciML.github.io/EnvironmentalTransport.jl/surface_runoff/"/><meta property="twitter:url" content="https://EarthSciML.github.io/EnvironmentalTransport.jl/surface_runoff/"/><link rel="canonical" href="https://EarthSciML.github.io/EnvironmentalTransport.jl/surface_runoff/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnvironmentalTransport.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../advection/">Advection</a></li><li><a class="tocitem" href="../puff/">Puff Model</a></li><li><a class="tocitem" href="../puff-gauss-kc/">Puff Gaussian KC</a></li><li class="is-active"><a class="tocitem" href>Surface Runoff</a><ul class="internal"><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Soil-Properties-(Table-1)"><span>Soil Properties (Table 1)</span></a></li><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li><li><a class="tocitem" href="#Analysis"><span>Analysis</span></a></li><li><a class="tocitem" href="#Limitations"><span>Limitations</span></a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../benchmarks/">üîó Benchmarks</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Surface Runoff</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Surface Runoff</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EarthSciML/EnvironmentalTransport.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/EarthSciML/EnvironmentalTransport.jl/blob/main/docs/src/surface_runoff.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Surface-Runoff-Model"><a class="docs-heading-anchor" href="#Surface-Runoff-Model">Surface Runoff Model</a><a id="Surface-Runoff-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Surface-Runoff-Model" title="Permalink"></a></h1><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>This module implements a surface runoff model based on the Saint-Venant equation system for surface water movement, coupled with a Heaviside step function boundary condition for surface-subsurface water flow interaction.</p><p>The Saint-Venant equations describe the mass conservation and momentum conservation of surface water flow along a soil surface slope. The Heaviside boundary condition enables automatic switching between infiltration and evaporation conditions at the soil surface based on the soil water pressure head.</p><p>The model includes three key processes:</p><ol><li>Surface water flow along the soil surface (Saint-Venant equations)</li><li>Friction effects via Manning&#39;s roughness equation</li><li>Automatic surface-subsurface boundary condition switching (Heaviside function)</li></ol><p><strong>Reference</strong>: Wang, Z., Timlin, D., Kouznetsov, M., Fleisher, D., Li, S., Tully, K., &amp; Reddy, V. (2020). Coupled model of surface runoff and surface-subsurface water movement. <em>Advances in Water Resources</em>, 137, 103499. <a href="https://doi.org/10.1016/j.advwatres.2019.103499">https://doi.org/10.1016/j.advwatres.2019.103499</a></p><article><details class="docstring" open="true"><summary id="EnvironmentalTransport.SurfaceRunoff"><a class="docstring-binding" href="#EnvironmentalTransport.SurfaceRunoff"><code>EnvironmentalTransport.SurfaceRunoff</code></a> ‚Äî <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">SurfaceRunoff(; name) -&gt; ModelingToolkitBase.System
</code></pre><p>Create a surface runoff model based on the Saint-Venant equation system for surface water movement, following the approach of Wang et al. (2020).</p><p>The model describes mass conservation and momentum conservation of surface water flow along a soil surface slope. The Saint-Venant equations are:</p><p class="math-container">\[\frac{\partial \tilde{h}}{\partial t} = -\frac{\partial q}{\partial l} + (P - I)\]</p><p class="math-container">\[\frac{\partial q}{\partial t} = -\frac{\partial}{\partial l}\left(\frac{q^2}{\tilde{h}} + \frac{g \tilde{h}^2}{2}\right) + g \tilde{h} (S_0 - S_f)\]</p><p>where <span>$\tilde{h}$</span> is the flow depth (ponded water height), <span>$q$</span> is the surface runoff flux per unit width, <span>$P$</span> is precipitation flux, <span>$I$</span> is infiltration flux, <span>$S_0$</span> is the surface slope, and <span>$S_f$</span> is the friction slope computed from Manning&#39;s equation.</p><p>This component represents the equations at a single surface node. The spatial derivative terms (<span>$\partial q / \partial l$</span> and the momentum flux divergence) are represented as input parameters that should be provided by a spatial discretization scheme or coupled model.</p><p><strong>Reference</strong>: Wang, Z., Timlin, D., Kouznetsov, M., Fleisher, D., Li, S., Tully, K., &amp; Reddy, V. (2020). Coupled model of surface runoff and surface-subsurface water movement. <em>Advances in Water Resources</em>, 137, 103499. https://doi.org/10.1016/j.advwatres.2019.103499</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/EnvironmentalTransport.jl/blob/f2e467c112b39c1cb5c735bd7c9556d4beb914b9/src/surface_runoff.jl#L3">source</a></section></details></article><article><details class="docstring" open="true"><summary id="EnvironmentalTransport.HeavisideBoundaryCondition"><a class="docstring-binding" href="#EnvironmentalTransport.HeavisideBoundaryCondition"><code>EnvironmentalTransport.HeavisideBoundaryCondition</code></a> ‚Äî <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">HeavisideBoundaryCondition(
;
    name
) -&gt; ModelingToolkitBase.System
</code></pre><p>Create a smoothed Heaviside boundary condition component for coupling surface and subsurface water flow, following Wang et al. (2020).</p><p>The Heaviside step function determines whether the soil surface is in a ponding state (h ‚â• 0) or unsaturated state (h &lt; 0), enabling automatic switching between infiltration and evaporation boundary conditions:</p><p class="math-container">\[\eta_\omega(h) = \frac{1}{\pi} \arctan\left(\frac{h}{\omega}\right) + \frac{1}{2}\]</p><p class="math-container">\[\delta_\omega(h) = \frac{1}{\pi} \frac{\omega}{\omega^2 + h^2}\]</p><p>These smooth approximations converge to the Heaviside step function and Dirac delta function respectively as <span>$\omega \to 0^+$</span>.</p><p>The boundary condition equation is (Eq. 3):</p><p class="math-container">\[\frac{\partial(\eta(h) \cdot h)}{\partial t} - (P - I) = 0\]</p><p><strong>Reference</strong>: Wang, Z., Timlin, D., Kouznetsov, M., Fleisher, D., Li, S., Tully, K., &amp; Reddy, V. (2020). Coupled model of surface runoff and surface-subsurface water movement. <em>Advances in Water Resources</em>, 137, 103499. https://doi.org/10.1016/j.advwatres.2019.103499</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/EnvironmentalTransport.jl/blob/f2e467c112b39c1cb5c735bd7c9556d4beb914b9/src/surface_runoff.jl#L200">source</a></section></details></article><article><details class="docstring" open="true"><summary id="EnvironmentalTransport.SaintVenantPDE"><a class="docstring-binding" href="#EnvironmentalTransport.SaintVenantPDE"><code>EnvironmentalTransport.SaintVenantPDE</code></a> ‚Äî <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">SaintVenantPDE(
    L_domain,
    T_end;
    P_val,
    I_val,
    S_0_val,
    n_manning_val,
    g_val,
    h_min_val,
    h_init_val,
    q_init_val,
    name
) -&gt; ModelingToolkitBase.PDESystem
</code></pre><p>Create a <code>PDESystem</code> for the Saint-Venant equations (Eq. 1 from Wang et al., 2020) suitable for spatial discretization with MethodOfLines.jl.</p><p>The system implements the full 1D Saint-Venant equations with proper SI units:</p><ul><li>Mass conservation (Eq. 1a): <span>$\partial \tilde{h}/\partial t = -\partial q/\partial l + (P - I)$</span></li><li>Momentum conservation (Eq. 1b): <span>$\partial q/\partial t = -\partial F/\partial l + g \tilde{h}(S_0 - S_f)$</span></li><li>Momentum flux (auxiliary): <span>$F = q^2/\tilde{h} + g \tilde{h}^2/2$</span></li></ul><p>where <span>$S_f$</span> is Manning&#39;s friction slope computed with non-dimensionalized fractional exponents: <span>$S_f = ((n/n_{ref})(q/q_{ref}))^2 / (\tilde{h}/h_{ref})^{10/3}$</span>.</p><p><strong>Arguments</strong></p><ul><li><code>L_domain</code>: Length of the spatial domain (m)</li><li><code>T_end</code>: Duration of the simulation (s)</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>P_val</code>: Precipitation rate (m/s), default 70 mm/hr</li><li><code>I_val</code>: Infiltration rate (m/s), default 0.0</li><li><code>S_0_val</code>: Surface slope (dimensionless), default 0.01</li><li><code>n_manning_val</code>: Manning roughness coefficient (m^(-1/3)¬∑s), default 0.03</li><li><code>g_val</code>: Gravitational acceleration (m/s¬≤), default 9.81</li><li><code>h_min_val</code>: Minimum flow depth to prevent singularity (m), default 1e-5</li><li><code>h_init_val</code>: Initial and boundary flow depth (m), default 1e-3</li><li><code>q_init_val</code>: Initial and boundary flux (m¬≤/s), default 0.0</li><li><code>name</code>: System name, default <code>:SaintVenantPDE</code></li></ul><p><strong>Reference</strong>: Wang, Z., Timlin, D., Kouznetsov, M., Fleisher, D., Li, S., Tully, K., &amp; Reddy, V. (2020). Coupled model of surface runoff and surface-subsurface water movement. <em>Advances in Water Resources</em>, 137, 103499. https://doi.org/10.1016/j.advwatres.2019.103499</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/EarthSciML/EnvironmentalTransport.jl/blob/f2e467c112b39c1cb5c735bd7c9556d4beb914b9/src/surface_runoff.jl#L83">source</a></section></details></article><h2 id="Soil-Properties-(Table-1)"><a class="docs-heading-anchor" href="#Soil-Properties-(Table-1)">Soil Properties (Table 1)</a><a id="Soil-Properties-(Table-1)-1"></a><a class="docs-heading-anchor-permalink" href="#Soil-Properties-(Table-1)" title="Permalink"></a></h2><p>The following table lists the soil physics properties and parameters for soil hydraulic models used in the numerical examples of Wang et al. (2020). Values are shown in the original paper units with SI equivalents.</p><table><tr><th style="text-align: left">Parameter</th><th style="text-align: center">Soil A</th><th style="text-align: center">Soil B</th><th style="text-align: left">SI Unit</th></tr><tr><td style="text-align: left">Residual Water Content (<span>$\theta_r$</span>)</td><td style="text-align: center">0.02</td><td style="text-align: center">0.02</td><td style="text-align: left">m<span>$^3$</span> m<span>$^{-3}$</span></td></tr><tr><td style="text-align: left">Saturated Water Content (<span>$\theta_s$</span>)</td><td style="text-align: center">0.33</td><td style="text-align: center">0.52</td><td style="text-align: left">m<span>$^3$</span> m<span>$^{-3}$</span></td></tr><tr><td style="text-align: left">van Genuchten Parameter (<span>$\alpha$</span>)</td><td style="text-align: center">0.04 (cm<span>$^{-1}$</span>) = 4.0 (m<span>$^{-1}$</span>)</td><td style="text-align: center">0.03 (cm<span>$^{-1}$</span>) = 3.0 (m<span>$^{-1}$</span>)</td><td style="text-align: left">m<span>$^{-1}$</span></td></tr><tr><td style="text-align: left">van Genuchten Parameter (<span>$n$</span>)</td><td style="text-align: center">2.0</td><td style="text-align: center">1.1</td><td style="text-align: left">dimensionless</td></tr><tr><td style="text-align: left">Saturated Hydraulic Conductivity (<span>$k_s$</span>)</td><td style="text-align: center">62.4 cm day<span>$^{-1}$</span> = 7.22<span>$\times 10^{-6}$</span> m s<span>$^{-1}$</span></td><td style="text-align: center">1.0 cm day<span>$^{-1}$</span> = 1.16<span>$\times 10^{-7}$</span> m s<span>$^{-1}$</span></td><td style="text-align: left">m s<span>$^{-1}$</span></td></tr><tr><td style="text-align: left">Soil Bulk Density (<span>$\rho_b$</span>)</td><td style="text-align: center">1.51 g cm<span>$^{-3}$</span> = 1510 kg m<span>$^{-3}$</span></td><td style="text-align: center">1.2 g cm<span>$^{-3}$</span> = 1200 kg m<span>$^{-3}$</span></td><td style="text-align: left">kg m<span>$^{-3}$</span></td></tr><tr><td style="text-align: left">Mass Fraction of Soil Organic Matter</td><td style="text-align: center">0.04</td><td style="text-align: center">0.04</td><td style="text-align: left">kg kg<span>$^{-1}$</span></td></tr><tr><td style="text-align: left">Mass Fraction of Sand</td><td style="text-align: center">0.95</td><td style="text-align: center">0.25</td><td style="text-align: left">kg kg<span>$^{-1}$</span></td></tr><tr><td style="text-align: left">Mass Fraction of Silt</td><td style="text-align: center">0.04</td><td style="text-align: center">0.15</td><td style="text-align: left">kg kg<span>$^{-1}$</span></td></tr></table><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><h3 id="SurfaceRunoff-Component"><a class="docs-heading-anchor" href="#SurfaceRunoff-Component">SurfaceRunoff Component</a><a id="SurfaceRunoff-Component-1"></a><a class="docs-heading-anchor-permalink" href="#SurfaceRunoff-Component" title="Permalink"></a></h3><p>The <code>SurfaceRunoff</code> component implements the Saint-Venant equation system (Eq. 1 from Wang et al., 2020) at a single surface computing node.</p><h4 id="State-Variables"><a class="docs-heading-anchor" href="#State-Variables">State Variables</a><a id="State-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#State-Variables" title="Permalink"></a></h4><pre><code class="language-julia hljs">using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities
using EnvironmentalTransport

sys = SurfaceRunoff()
vars = unknowns(sys)
DataFrame(
    :Name =&gt; [string(Symbolics.tosymbol(v, escape = false)) for v in vars],
    :Units =&gt; [string(dimension(ModelingToolkit.get_unit(v))) for v in vars],
    :Description =&gt; [ModelingToolkit.getdescription(v) for v in vars]
)</code></pre><div><div style = "float: left;"><span>3√ó3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Name</th><th style = "text-align: left;">Units</th><th style = "text-align: left;">Description</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">hÃÉ</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Flow depth / ponded water height (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">q</td><td style = "text-align: left;">m¬≤ s‚Åª¬π</td><td style = "text-align: left;">Surface runoff flux per unit width (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">S_f</td><td style = "text-align: left;"></td><td style = "text-align: left;">Friction slope from Manning&apos;s equation (Eq. 1)</td></tr></tbody></table></div><h4 id="Parameters"><a class="docs-heading-anchor" href="#Parameters">Parameters</a><a id="Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters" title="Permalink"></a></h4><pre><code class="language-julia hljs">params = parameters(sys)
DataFrame(
    :Name =&gt; [string(Symbolics.tosymbol(p, escape = false)) for p in params],
    :Units =&gt; [try string(dimension(ModelingToolkit.get_unit(p))) catch; &quot;dimensionless&quot; end for p in params],
    :Description =&gt; [ModelingToolkit.getdescription(p) for p in params]
)</code></pre><div><div style = "float: left;"><span>11√ó3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Name</th><th style = "text-align: left;">Units</th><th style = "text-align: left;">Description</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">dqdl</td><td style = "text-align: left;">m s‚Åª¬π</td><td style = "text-align: left;">Spatial derivative of runoff flux ‚àÇq/‚àÇl (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">I_infil</td><td style = "text-align: left;">m s‚Åª¬π</td><td style = "text-align: left;">Infiltration flux density (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">P</td><td style = "text-align: left;">m s‚Åª¬π</td><td style = "text-align: left;">Precipitation/irrigation flux density (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">dFdl</td><td style = "text-align: left;">m¬≤ s‚Åª¬≤</td><td style = "text-align: left;">Spatial derivative of momentum flux ‚àÇ/‚àÇl(q¬≤/hÃÉ + g¬∑hÃÉ¬≤/2) (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">S_0</td><td style = "text-align: left;"></td><td style = "text-align: left;">Surface slope (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">6</td><td style = "text-align: left;">hÃÉ_0</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Minimum flow depth to prevent singularity (Eq. 1)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">7</td><td style = "text-align: left;">g</td><td style = "text-align: left;">m s‚Åª¬≤</td><td style = "text-align: left;">Gravitational acceleration</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">8</td><td style = "text-align: left;">n_mann</td><td style = "text-align: left;">m‚Åª¬π·êü¬≥ s</td><td style = "text-align: left;">Manning roughness coefficient</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">9</td><td style = "text-align: left;">q_ref</td><td style = "text-align: left;">m¬≤ s‚Åª¬π</td><td style = "text-align: left;">Reference flux for non-dimensionalization</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">10</td><td style = "text-align: left;">n_ref</td><td style = "text-align: left;">m‚Åª¬π·êü¬≥ s</td><td style = "text-align: left;">Reference Manning coefficient for non-dimensionalization</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">11</td><td style = "text-align: left;">h_ref</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Reference flow depth for non-dimensionalization</td></tr></tbody></table></div><h4 id="Equations"><a class="docs-heading-anchor" href="#Equations">Equations</a><a id="Equations-1"></a><a class="docs-heading-anchor-permalink" href="#Equations" title="Permalink"></a></h4><pre><code class="language-julia hljs">eqs = equations(sys)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} ~ \mathtt{\tilde{h}}\left( t \right)}{\mathrm{d}t} &amp;=  - \mathtt{I\_infil} + P - \mathtt{dqdl} \\
\frac{\mathrm{d} ~ q\left( t \right)}{\mathrm{d}t} &amp;=  - \mathtt{dFdl} + \left( \mathtt{S\_0} - \mathtt{S\_f}\left( t \right) \right) ~ g ~ max\left( \mathtt{\tilde{h}}\left( t \right), \mathtt{\tilde{h}\_0} \right) \\
\mathtt{S\_f}\left( t \right) &amp;= \frac{\left( \frac{\mathtt{n\_mann} ~ q\left( t \right)}{\mathtt{n\_ref} ~ \mathtt{q\_ref}} \right)^{2}}{\left( \frac{max\left( \mathtt{\tilde{h}}\left( t \right), \mathtt{\tilde{h}\_0} \right)}{\mathtt{h\_ref}} \right)^{3.3333}}
\end{align}
 \]</p><h3 id="HeavisideBoundaryCondition-Component"><a class="docs-heading-anchor" href="#HeavisideBoundaryCondition-Component">HeavisideBoundaryCondition Component</a><a id="HeavisideBoundaryCondition-Component-1"></a><a class="docs-heading-anchor-permalink" href="#HeavisideBoundaryCondition-Component" title="Permalink"></a></h3><p>The <code>HeavisideBoundaryCondition</code> component implements the smoothed Heaviside step function (Eq. 5) and the surface boundary condition (Eq. 3) for coupling surface and subsurface water flow.</p><h4 id="State-Variables-2"><a class="docs-heading-anchor" href="#State-Variables-2">State Variables</a><a class="docs-heading-anchor-permalink" href="#State-Variables-2" title="Permalink"></a></h4><pre><code class="language-julia hljs">hbc = HeavisideBoundaryCondition()
vars_hbc = unknowns(hbc)
DataFrame(
    :Name =&gt; [string(Symbolics.tosymbol(v, escape = false)) for v in vars_hbc],
    :Units =&gt; [try string(dimension(ModelingToolkit.get_unit(v))) catch; &quot;dimensionless&quot; end for v in vars_hbc],
    :Description =&gt; [ModelingToolkit.getdescription(v) for v in vars_hbc]
)</code></pre><div><div style = "float: left;"><span>3√ó3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Name</th><th style = "text-align: left;">Units</th><th style = "text-align: left;">Description</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">h</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Soil water pressure head at surface (Eq. 3)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">Œ∑_œâ</td><td style = "text-align: left;"></td><td style = "text-align: left;">Smoothed Heaviside step function (Eq. 5) (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">Œ¥_œâ</td><td style = "text-align: left;">m‚Åª¬π</td><td style = "text-align: left;">Smoothed Dirac delta function (Eq. 5)</td></tr></tbody></table></div><h4 id="Parameters-2"><a class="docs-heading-anchor" href="#Parameters-2">Parameters</a><a class="docs-heading-anchor-permalink" href="#Parameters-2" title="Permalink"></a></h4><pre><code class="language-julia hljs">params_hbc = parameters(hbc)
DataFrame(
    :Name =&gt; [string(Symbolics.tosymbol(p, escape = false)) for p in params_hbc],
    :Units =&gt; [try string(dimension(ModelingToolkit.get_unit(p))) catch; &quot;dimensionless&quot; end for p in params_hbc],
    :Description =&gt; [ModelingToolkit.getdescription(p) for p in params_hbc]
)</code></pre><div><div style = "float: left;"><span>5√ó3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Name</th><th style = "text-align: left;">Units</th><th style = "text-align: left;">Description</th></tr><tr class = "columnLabelRow"><th class = "stubheadLabel" style = "font-weight: bold; text-align: right;"></th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th><th title = "String" style = "text-align: left;">String</th></tr></thead><tbody><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">one_over_pi</td><td style = "text-align: left;"></td><td style = "text-align: left;">1/œÄ constant (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">œâ</td><td style = "text-align: left;">m</td><td style = "text-align: left;">Smoothing parameter for Heaviside approximation (Eq. 5)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">one_half</td><td style = "text-align: left;"></td><td style = "text-align: left;">1/2 constant (dimensionless)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: left;">I_infil</td><td style = "text-align: left;">m s‚Åª¬π</td><td style = "text-align: left;">Infiltration flux density (Eq. 3)</td></tr><tr class = "dataRow"><td class = "rowLabel" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: left;">P</td><td style = "text-align: left;">m s‚Åª¬π</td><td style = "text-align: left;">Precipitation/irrigation flux density (Eq. 3)</td></tr></tbody></table></div><h4 id="Equations-2"><a class="docs-heading-anchor" href="#Equations-2">Equations</a><a class="docs-heading-anchor-permalink" href="#Equations-2" title="Permalink"></a></h4><pre><code class="language-julia hljs">eqs_hbc = equations(hbc)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} ~ h\left( t \right)}{\mathrm{d}t} &amp;= \frac{ - \mathtt{I\_infil} + P}{\mathtt{\eta\_\omega}\left( t \right) + h\left( t \right) ~ \mathtt{\delta\_\omega}\left( t \right)} \\
\mathtt{\eta\_\omega}\left( t \right) &amp;= \mathtt{one\_half} + \mathtt{one\_over\_pi} ~ \arctan\left( \frac{h\left( t \right)}{\omega} \right) \\
\mathtt{\delta\_\omega}\left( t \right) &amp;= \frac{\mathtt{one\_over\_pi} ~ \omega}{\left( h\left( t \right) \right)^{2} + \omega^{2}}
\end{align}
 \]</p><h2 id="Analysis"><a class="docs-heading-anchor" href="#Analysis">Analysis</a><a id="Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Analysis" title="Permalink"></a></h2><h3 id="Smoothed-Heaviside-Step-Function-(Eq.-5)"><a class="docs-heading-anchor" href="#Smoothed-Heaviside-Step-Function-(Eq.-5)">Smoothed Heaviside Step Function (Eq. 5)</a><a id="Smoothed-Heaviside-Step-Function-(Eq.-5)-1"></a><a class="docs-heading-anchor-permalink" href="#Smoothed-Heaviside-Step-Function-(Eq.-5)" title="Permalink"></a></h3><p>The smoothed Heaviside function <span>$\eta_\omega(h)$</span> transitions from 0 to 1 around <span>$h = 0$</span>, with the sharpness controlled by the parameter <span>$\omega$</span>. Smaller values of <span>$\omega$</span> produce a sharper transition, approaching the true Heaviside step function.</p><pre><code class="language-julia hljs">using OrdinaryDiffEqDefault
using Plots

# Evaluate Œ∑_œâ for different œâ values
h_range = range(-0.01, 0.01, length=500)

p = plot(xlabel=&quot;Soil water pressure head h (m)&quot;,
         ylabel=&quot;Œ∑_œâ(h)&quot;,
         title=&quot;Smoothed Heaviside Step Function (Eq. 5)&quot;)

for œâ_val in [1e-2, 1e-3, 1e-4]
    Œ∑_vals = [(1/œÄ) * atan(h / œâ_val) + 0.5 for h in h_range]
    plot!(p, h_range, Œ∑_vals, label=&quot;œâ = $œâ_val m&quot;, linewidth=2)
end

p</code></pre><img src="df809032.svg" alt="Example block output"/><h3 id="Smoothed-Dirac-Delta-Function-(Eq.-5)"><a class="docs-heading-anchor" href="#Smoothed-Dirac-Delta-Function-(Eq.-5)">Smoothed Dirac Delta Function (Eq. 5)</a><a id="Smoothed-Dirac-Delta-Function-(Eq.-5)-1"></a><a class="docs-heading-anchor-permalink" href="#Smoothed-Dirac-Delta-Function-(Eq.-5)" title="Permalink"></a></h3><p>The smoothed Dirac delta function <span>$\delta_\omega(h)$</span> is the derivative of the smoothed Heaviside function. It peaks at <span>$h = 0$</span> with amplitude <span>$1/(\pi\omega)$</span>.</p><pre><code class="language-julia hljs">p2 = plot(xlabel=&quot;Soil water pressure head h (m)&quot;,
          ylabel=&quot;Œ¥_œâ(h) (1/m)&quot;,
          title=&quot;Smoothed Dirac Delta Function (Eq. 5)&quot;)

for œâ_val in [1e-2, 1e-3, 1e-4]
    Œ¥_vals = [(1/œÄ) * œâ_val / (œâ_val^2 + h^2) for h in h_range]
    plot!(p2, h_range, Œ¥_vals, label=&quot;œâ = $œâ_val m&quot;, linewidth=2)
end

p2</code></pre><img src="908edd85.svg" alt="Example block output"/><h3 id="Boundary-Condition-Transition:-Unsaturated-to-Ponding"><a class="docs-heading-anchor" href="#Boundary-Condition-Transition:-Unsaturated-to-Ponding">Boundary Condition Transition: Unsaturated to Ponding</a><a id="Boundary-Condition-Transition:-Unsaturated-to-Ponding-1"></a><a class="docs-heading-anchor-permalink" href="#Boundary-Condition-Transition:-Unsaturated-to-Ponding" title="Permalink"></a></h3><p>This example demonstrates the automatic switching behavior of the Heaviside boundary condition (Eq. 3). Starting from an unsaturated state (<span>$h &lt; 0$</span>), precipitation drives the soil water pressure head toward positive values, transitioning from unsaturated to ponded conditions.</p><pre><code class="language-julia hljs">hbc = HeavisideBoundaryCondition()
chbc = mtkcompile(hbc)

# Scenario: Start unsaturated, apply precipitation with partial infiltration
prob = ODEProblem(chbc,
    merge(
        Dict(chbc.h =&gt; -0.05),
        Dict(chbc.P =&gt; 1e-5, chbc.I_infil =&gt; 0.0, chbc.œâ =&gt; 1e-3)
    ),
    (0.0, 20000.0))
sol = solve(prob)

p3 = plot(sol.t, sol[chbc.h] .* 100,
     xlabel=&quot;Time (s)&quot;, ylabel=&quot;Pressure head h (cm)&quot;,
     title=&quot;Boundary Condition Transition (Eq. 3)&quot;,
     label=&quot;h(t)&quot;, linewidth=2, legend=:bottomright)
hline!(p3, [0.0], linestyle=:dash, color=:red, label=&quot;h = 0 (ponding threshold)&quot;)

p3</code></pre><img src="8d1f54a8.svg" alt="Example block output"/><h3 id="Manning&#39;s-Friction-Effect-on-Surface-Runoff"><a class="docs-heading-anchor" href="#Manning&#39;s-Friction-Effect-on-Surface-Runoff">Manning&#39;s Friction Effect on Surface Runoff</a><a id="Manning&#39;s-Friction-Effect-on-Surface-Runoff-1"></a><a class="docs-heading-anchor-permalink" href="#Manning&#39;s-Friction-Effect-on-Surface-Runoff" title="Permalink"></a></h3><p>This example shows how Manning&#39;s roughness coefficient affects the friction slope and thus the momentum balance in the Saint-Venant equations (Eq. 1). Higher roughness produces greater friction, reducing flow velocity. Note that this single-node model demonstrates the local momentum response; in a full spatial simulation, the spatial flux terms would transport momentum downstream.</p><pre><code class="language-julia hljs">sys_sr = SurfaceRunoff()
csys = mtkcompile(sys_sr)

# Compare different Manning coefficients with steady precipitation
# Using a short time window to observe the initial momentum response
p4 = plot(xlabel=&quot;Time (s)&quot;, ylabel=&quot;Runoff flux q (m¬≤/s)&quot;,
          title=&quot;Effect of Manning&#39;s Roughness on Runoff (Eq. 1)&quot;,
          legend=:topleft)

for (n_val, label) in [(0.01, &quot;n=0.01 (smooth)&quot;),
                        (0.03, &quot;n=0.03 (bare soil)&quot;),
                        (0.10, &quot;n=0.10 (dense grass)&quot;)]
    prob_sr = ODEProblem(csys,
        merge(
            Dict(csys.hÃÉ =&gt; 1e-3, csys.q =&gt; 0.0),
            Dict(
                csys.P =&gt; 2e-5,
                csys.I_infil =&gt; 1e-5,
                csys.S_0 =&gt; 0.01,
                csys.n_mann =&gt; n_val,
                csys.hÃÉ_0 =&gt; 1e-5,
                csys.dqdl =&gt; 0.0,
                csys.dFdl =&gt; 0.0,
            )
        ),
        (0.0, 5.0))
    sol_sr = solve(prob_sr)
    plot!(p4, sol_sr.t, sol_sr[csys.q], label=label, linewidth=2)
end

p4</code></pre><img src="42263286.svg" alt="Example block output"/><h3 id="Water-Depth-Accumulation-Under-Different-Precipitation-Infiltration-Regimes"><a class="docs-heading-anchor" href="#Water-Depth-Accumulation-Under-Different-Precipitation-Infiltration-Regimes">Water Depth Accumulation Under Different Precipitation-Infiltration Regimes</a><a id="Water-Depth-Accumulation-Under-Different-Precipitation-Infiltration-Regimes-1"></a><a class="docs-heading-anchor-permalink" href="#Water-Depth-Accumulation-Under-Different-Precipitation-Infiltration-Regimes" title="Permalink"></a></h3><p>This example demonstrates the mass conservation equation (Eq. 1a) under different net water input scenarios, showing how the balance between precipitation and infiltration controls ponded water depth.</p><pre><code class="language-julia hljs">p5 = plot(xlabel=&quot;Time (s)&quot;, ylabel=&quot;Flow depth hÃÉ (m)&quot;,
          title=&quot;Water Depth vs. Net Water Input (Eq. 1a)&quot;,
          legend=:topleft)

for (P_val, I_val, label) in [
    (3e-5, 1e-5, &quot;P=3e-5, I=1e-5 (net gain)&quot;),
    (2e-5, 2e-5, &quot;P=2e-5, I=2e-5 (balanced)&quot;),
    (1e-5, 2e-5, &quot;P=1e-5, I=2e-5 (net loss)&quot;)]
    prob_acc = ODEProblem(csys,
        merge(
            Dict(csys.hÃÉ =&gt; 0.005, csys.q =&gt; 0.0),
            Dict(
                csys.P =&gt; P_val,
                csys.I_infil =&gt; I_val,
                csys.S_0 =&gt; 0.0,
                csys.n_mann =&gt; 0.03,
                csys.hÃÉ_0 =&gt; 1e-5,
                csys.dqdl =&gt; 0.0,
                csys.dFdl =&gt; 0.0,
            )
        ),
        (0.0, 200.0))
    sol_acc = solve(prob_acc)
    plot!(p5, sol_acc.t, sol_acc[csys.hÃÉ], label=label, linewidth=2)
end

p5</code></pre><img src="25b37fb8.svg" alt="Example block output"/><h3 id="PDE-Spatial-Solution-with-MethodOfLines.jl"><a class="docs-heading-anchor" href="#PDE-Spatial-Solution-with-MethodOfLines.jl">PDE Spatial Solution with MethodOfLines.jl</a><a id="PDE-Spatial-Solution-with-MethodOfLines.jl-1"></a><a class="docs-heading-anchor-permalink" href="#PDE-Spatial-Solution-with-MethodOfLines.jl" title="Permalink"></a></h3><p>The full Saint-Venant equations (Eq. 1 from Wang et al., 2020) can be solved as a PDE system using <a href="https://github.com/SciML/MethodOfLines.jl">MethodOfLines.jl</a> for spatial discretization via the method of lines (finite differences).</p><p>The <code>SaintVenantPDE</code> function creates a <code>PDESystem</code> with proper SI units that can be directly discretized with MethodOfLines.jl. All variables and parameters carry SI unit annotations, and unit consistency is verified during system construction.</p><pre><code class="language-julia hljs">using ModelingToolkit: t
using DomainSets
using MethodOfLines

# Create the Saint-Venant PDE system with 70 mm/hr rainfall on a 0.5 m domain
pde = SaintVenantPDE(0.5, 60.0;
    P_val = 70.0 / 1000 / 3600,  # 70 mm/hr in m/s
    S_0_val = 0.01,
    n_manning_val = 0.03,
    h_init_val = 1e-3,
    q_init_val = 0.0)

# Discretize using method of lines (finite differences)
l = pde.ivs[2]
dl = 0.1
discretization = MOLFiniteDifference([l =&gt; dl], t, approx_order = 2)
prob = discretize(pde, discretization; checks = false)

# Solve the discretized ODE system
sol = solve(prob)

h_tilde = pde.dvs[1]
q_flux = pde.dvs[2]
disc_l = sol[l]
h_vals = sol[h_tilde]

# Plot spatial profiles of water depth at different times
p6 = plot(xlabel=&quot;Distance along slope l (m)&quot;,
          ylabel=&quot;Flow depth hÃÉ (m)&quot;,
          title=&quot;Saint-Venant PDE: Water Depth Evolution (Eq. 1)&quot;,
          legend=:topleft)

for (i, ti) in enumerate(sol.t)
    label_str = &quot;t = $(round(ti, digits=1)) s&quot;
    plot!(p6, disc_l, h_vals[i, :], label=label_str, linewidth=2)
end

p6</code></pre><img src="cb981f7d.svg" alt="Example block output"/><pre><code class="language-julia hljs">println(&quot;ODEProblem created with $(length(prob.u0)) unknowns&quot;)
println(&quot;Time span: $(prob.tspan)&quot;)
println(&quot;Solution time steps: $(length(sol.t))&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ODEProblem created with 8 unknowns
Time span: (0.0, 60.0)
Solution time steps: 28</code></pre><h2 id="Limitations"><a class="docs-heading-anchor" href="#Limitations">Limitations</a><a id="Limitations-1"></a><a class="docs-heading-anchor-permalink" href="#Limitations" title="Permalink"></a></h2><p>The current implementation provides:</p><ul><li><strong>Single-node ODE components</strong> (<code>SurfaceRunoff</code>, <code>HeavisideBoundaryCondition</code>) suitable for coupling with the EarthSciML framework</li><li><strong>PDE spatial solution</strong> (<code>SaintVenantPDE</code>) via MethodOfLines.jl discretization of the Saint-Venant equations (Eq. 1) with full SI unit support</li></ul><p>The following features from Wang et al. (2020) are not yet implemented:</p><ul><li>Richards equation for subsurface flow (Eq. 2) ‚Äî requires a separate subsurface flow component</li><li>Coupled surface-subsurface simulations (Figs. 3-6) ‚Äî requires both surface and subsurface models</li><li>Ridge-furrow water harvesting application (Figs. 7-8) ‚Äî requires the full coupled model with complex topography</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../puff-gauss-kc/">¬´ Puff Gaussian KC</a><a class="docs-footer-nextpage" href="../api/">API ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.17.0 on <span class="colophon-date" title="Friday 27 February 2026 12:58">Friday 27 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
