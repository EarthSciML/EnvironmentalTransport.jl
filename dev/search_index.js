var documenterSearchIndex = {"docs":
[{"location":"puff/#Air-Pollution-\"Puff\"-Model-Example","page":"Puff Model","title":"Air Pollution \"Puff\" Model Example","text":"using EarthSciMLBase, EarthSciData, EnvironmentalTransport\nusing ModelingToolkit\nusing ModelingToolkit: t\nusing DynamicQuantities\nusing DifferentialEquations\nusing Plots\nusing Dates\n\nfirestart = DateTime(2021, 10, 1)\nfirelength = 15 * 24 * 3600 # Seconds\nsimulationlength = 20 # Days\nfirelon = deg2rad(-97)\nfirelat = deg2rad(40)\nfireradius = deg2rad(0.05) # Degrees\nsamplerate = 3600.0 # Seconds\nsamples_per_time = 1 # Samples per each emission time\nfireheight = 2.0 # Vertical level (Allowing this to be automatically calculated is a work in progress).\nemis_rate = 1.0 # kg/s, fire emission rate\n\nsim_end = firestart + Day(simulationlength)\n\ndomain = DomainInfo(\n    firestart, sim_end;\n    lonrange = deg2rad(-115):deg2rad(1.25):deg2rad(-68.75),\n    latrange = deg2rad(25):deg2rad(1):deg2rad(53.7),\n    levrange = 1:72\n)\n\ngeosfp = GEOSFP(\"4x5\", domain; stream = false)\n\npuff = Puff(domain)\n\nmodel = couple(puff, geosfp)\nconst sys = convert(System, model)\nu0 = ModelingToolkit.get_defaults(sys)\ntspan = EarthSciMLBase.get_tspan(domain)\nprob=ODEProblem(sys, u0, tspan)\nsol = solve(prob, Tsit5()) # Solve once to make sure data is loaded.\n\nfunction prob_func(prob, i, repeat)\n    r = rand() * fireradius\n    Î¸ = rand() * 2Ï€\n    u0 = [\n        sys.Puffâ‚Šlon => firelon + r * cos(Î¸),\n        sys.Puffâ‚Šlat => firelat + r * sin(Î¸),\n        sys.Puffâ‚Šlev => fireheight\n    ]\n    ts = (tspan[1] + floor(i / samples_per_time) * samplerate, tspan[2])\n    remake(prob, u0 = u0, tspan = ts)\nend\neprob = EnsembleProblem(prob, prob_func = prob_func, safetycopy = false)\nesol = solve(eprob, Tsit5(); trajectories = ceil(firelength/samplerate*samples_per_time))\n\nvars = [sys.Puffâ‚Šlon, sys.Puffâ‚Šlat, sys.Puffâ‚Šlev]\nvaridxs = ModelingToolkit.variable_index.((sys,), vars)\nranges = [(Inf, -Inf), (Inf, -Inf), (Inf, -Inf)]\nfor sol in esol\n    for (i, var) in enumerate(vars)\n        rng = (minimum(sol[var]), maximum(sol[var]))\n        ranges[i] = (min(ranges[i][1], rng[1]),\n            max(ranges[i][2], rng[2]))\n    end\nend\n\nt_ref = get_tref(domain)\nanim = @animate for dt in datetime2unix(firestart):samplerate:datetime2unix(sim_end)\n    t = dt - t_ref\n    p = plot(\n        xlim = rad2deg.(ranges[1]), ylim = rad2deg.(ranges[2]), zlim = ranges[3],\n        title = \"Time: $(unix2datetime(t + t_ref))\",\n        xlabel = \"Longitude (deg)\", ylabel = \"Latitude (deg)\",\n        zlabel = \"Vertical Level\"\n    )\n    for sol in esol\n        if t < sol.t[1] || t > sol.t[end]\n            continue\n        end\n        lon, lat, lev = sol(t)[varidxs[1]], sol(t)[varidxs[2]], sol(t)[varidxs[3]]\n        color = lev < 2 ? :red : :black\n        scatter!(p,\n            [rad2deg(sol(t)[varidxs[1]])], [rad2deg(sol(t)[varidxs[2]])], [sol(t)[varidxs[3]]],\n            label = :none, markercolor = color, markerstrokecolor = color, markersize = 1.5\n        )\n    end\nend\ngif(anim, fps = 15)","category":"section"},{"location":"benchmarks/#Redirecting...","page":"ðŸ”— Benchmarks","title":"Redirecting...","text":"<html>\n<head>\n    <meta http-equiv=\"refresh\" content=\"0; url=https://transport.earthsci.dev/benchmarks/\" />\n</head>\n<body>\n    <p>If you are not redirected automatically, follow this <a href=\"https://transport.earthsci.dev/benchmarks/\">link</a>.</p>\n</body>\n</html>","category":"section"},{"location":"api/#API-Index","page":"API","title":"API Index","text":"","category":"section"},{"location":"api/#API-Documentation","page":"API","title":"API Documentation","text":"","category":"section"},{"location":"api/#EnvironmentalTransport.AdvectionOperator","page":"API","title":"EnvironmentalTransport.AdvectionOperator","text":"Create an EarthSciMLBase.Operator that performs advection. Advection is performed using the given stencil operator (e.g. l94_stencil or ppm_stencil). p is an optional parameter set to be used by the stencil operator. bc_type is the boundary condition type, e.g. ZeroGradBC().\n\nWind field data will be added in automatically if available. Currently the only valid source of wind data is EarthSciData.GEOSFP.\n\n\n\n\n\n","category":"type"},{"location":"api/#EnvironmentalTransport.BCArray","page":"API","title":"EnvironmentalTransport.BCArray","text":"An array with external indexing implemented for boundary conditions.\n\n\n\n\n\n","category":"type"},{"location":"api/#EnvironmentalTransport.ConstantBC","page":"API","title":"EnvironmentalTransport.ConstantBC","text":"Constant boundary conditions.\n\n\n\n\n\n","category":"type"},{"location":"api/#EnvironmentalTransport.ConstantBCArray","page":"API","title":"EnvironmentalTransport.ConstantBCArray","text":"An array with zero constant boundary conditions.\n\n\n\n\n\n","category":"type"},{"location":"api/#EnvironmentalTransport.ZeroGradBC","page":"API","title":"EnvironmentalTransport.ZeroGradBC","text":"Zero gradient boundary conditions.\n\n\n\n\n\n","category":"type"},{"location":"api/#EnvironmentalTransport.ZeroGradBCArray","page":"API","title":"EnvironmentalTransport.ZeroGradBCArray","text":"An array with zero gradient boundary conditions.\n\n\n\n\n\n","category":"type"},{"location":"api/#EnvironmentalTransport.AtmosphericPressureProfile-Tuple{}","page":"API","title":"EnvironmentalTransport.AtmosphericPressureProfile","text":"AtmosphericPressureProfile(; name=:AtmosphericPressureProfile)\n\nCalculates atmospheric pressure as a function of altitude for an isothermal atmosphere.\n\nImplements:\n\nEquation 1.1: dp/dz = -rho * g (hydrostatic equation)\nEquation 1.3: dp/dz = -M_air * g * p / (R * T) (combined form)\nEquation 1.5: p(z)/p_0 = exp(-z/H) (barometric formula, isothermal case)\n\nThis component uses the barometric formula (Eq. 1.5) which is the integrated form of the hydrostatic equation for an isothermal atmosphere.\n\nNote: For a non-isothermal atmosphere, the scale height varies with altitude and numerical integration of Eq. 1.3 would be required.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.AtmosphericStability-Tuple{}","page":"API","title":"EnvironmentalTransport.AtmosphericStability","text":"AtmosphericStability(; name=:AtmosphericStability)\n\nReturns a ModelingToolkit.System that computes atmospheric stability parameters including potential temperature, dry adiabatic lapse rate, and stability classification.\n\nBased on Chapter 16 \"Meteorology of the Local Scale\" from Seinfeld & Pandis (2006) \"Atmospheric Chemistry and Physics\", 2nd Edition, pp. 720-760.\n\nKey equations implemented:\n\nEq. 16.8: Dry adiabatic lapse rate Î“ = g/Ä‰_p â‰ˆ 9.76 K/km\nEq. 16.14: Potential temperature Î¸ = T(pâ‚€/p)^(R/Ä‰_p)\nEq. 16.16-16.18: Stability classification based on âˆ‚Î¸/âˆ‚z\n\nThe stability parameter S indicates:\n\nS > 0: Stable atmosphere (âˆ‚Î¸/âˆ‚z > 0)\nS = 0: Neutral atmosphere (âˆ‚Î¸/âˆ‚z = 0)\nS < 0: Unstable atmosphere (âˆ‚Î¸/âˆ‚z < 0)\n\nExample:\n\nusing ModelingToolkit, EnvironmentalTransport\n\nstab = AtmosphericStability()\nsys = mtkcompile(stab)\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.AtmosphericThermodynamics-Tuple{}","page":"API","title":"EnvironmentalTransport.AtmosphericThermodynamics","text":"AtmosphericThermodynamics(; name=:AtmosphericThermodynamics)\n\nComplete atmospheric thermodynamics system combining:\n\nEquation 1.2: Ideal gas law for density\nEquation 1.4: Scale height\nEquation 1.5: Barometric formula\nEquation 1.7: Total molar concentration\n\nThis composite system calculates pressure, density, scale height, and total molar concentration given altitude and temperature for an isothermal atmosphere.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.BarometricFormula-Tuple{}","page":"API","title":"EnvironmentalTransport.BarometricFormula","text":"BarometricFormula(; name=:BarometricFormula)\n\nCalculates pressure at a given altitude using the barometric formula.\n\nImplements Equation 1.5: p(z) = p_0 * exp(-z/H)\n\nThis is the integrated form of the hydrostatic equation for an isothermal atmosphere. The scale height H is provided as an input.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.GaussianPGB-Tuple{}","page":"API","title":"EnvironmentalTransport.GaussianPGB","text":"GaussianPGB()\n\nReturn a ModelingToolkit.System implementing a classic Gaussian plume dispersion model, parameterized with Pasquill-Gifford-Briggs dispersion coefficients, following the formulations described in EPA guidance 402-R-00-004 Â§12.1.6 (https://19january2017snapshot.epa.gov/sites/production/files/2015-05/documents/402-r-00-004.pdf) and the MMGRMA document, Table 6-7 (https://www.epa.gov/sites/default/files/2020-10/documents/mmgrma_0.pdf). Good for: quasi-steady (piecewise-steady) applications where emissions and meteorology can be treated steady over each model time step; near-field ranges (typically â‰¤ 50 km); and cases where the effective plume height remains within the planetary boundary layer.\n\nWhat this does:\n\nStability classification: Uses near-surface meteorology (10 m wind speed, downward short-wave radiation, total cloud fraction, and the surface temperature lapse) to determine the Pasquill stability class.\nDispersion coefficients: Maps the stability class to Briggs coefficients (Ay, Az, By, Bz) and evaluates the analytic expressions for the horizontal (sigmah â‰¡ sigmay) and vertical (sigma_z) dispersion parameters as functions of the down-wind distance 'x'.\nHypsometric height: Computes puff height above ground (z_agl) from pressure, temperature, and humidity using the hypsometric equation with a virtual temperature layer mean.\nGround-level concentration: Computes the Gaussian ground-level concentration at the puff center for one unit of puff mass: Cgl = 1 / ((2Ï€)^{3/2} Â· ÏƒhÂ² Â· Ïƒz) * exp(-zaglÂ² / (2 Ïƒ_zÂ²)).\n\nExample:\n\nusing Dates, EarthSciMLBase, EarthSciData, EnvironmentalTransport\nusing ModelingToolkit, OrdinaryDiffEq\n\nt0 = DateTime(2022, 5, 1)\nt1 = DateTime(2022, 5, 2)\nÎ”Î»      = deg2rad(5.0)\nÎ”Ï†      = deg2rad(4.0)\n\ndom = DomainInfo(t0, t1; levrange=1:72,\n                    lonrange = deg2rad(-130):Î”Î»:deg2rad(-60),\n                    latrange = deg2rad(25):Î”Ï†:deg2rad(61))\n\nmdl = couple(Puff(dom),\n             GEOSFP(\"4x5\", dom; stream=false),\n             GaussianPGB())\n\nsys  = convert(System, mdl)\n\nu0 = [sys.Puffâ‚Šlon => deg2rad(-105),\n      sys.Puffâ‚Šlat => deg2rad(  38),\n      sys.Puffâ‚Šlev => 2]\n\np  = [sys.GaussianPGBâ‚Šlon0 => deg2rad(-105),\n      sys.GaussianPGBâ‚Šlat0 => deg2rad(  38)]\n\nprob = ODEProblem(sys, u0, (datetime2unix(t0), datetime2unix(t1)), p)\nsol = solve(prob, Tsit5();)\n\nsigma_h = sol[sys.GaussianPGBâ‚Šsigma_h]\nsigma_z = sol[sys.GaussianPGBâ‚Šsigma_z]\nC_gl    = sol[sys.GaussianPGBâ‚ŠC_gl]\n\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.GaussianSD-Tuple{}","page":"API","title":"EnvironmentalTransport.GaussianSD","text":"GaussianSD()\n\nReturns a ModelingToolkit.System that calculates horizontal dispersion (Ïƒh) from velocity deformation (Smagorinsky/Deardorff), and computes hypsometric height (zagl) and ground-level centerline concentration per unit mass. The ground-level concentration is only evaluated when the puff is within the ground layer (z_agl â‰¤ Î”z); otherwise it is set to zero.\n\nReferences (NOAA ARL MetMag report): https://www.arl.noaa.gov/documents/reports/MetMag.pdf\n\nHorizontal mixing coefficient: Eq. 12\nStandard deviation of the turbulent velocity: Eq. 15\nÏƒ_h tendency: Eq. 16\nCenterline ground-level concentration: Eq. 18\n\nExample:\n\nusing Dates, EarthSciMLBase, EarthSciData, EnvironmentalTransport\nusing ModelingToolkit, OrdinaryDiffEq\n\nt0 = DateTime(2022, 5, 1)\nt1 = DateTime(2022, 5, 2)\nÎ”Î»      = deg2rad(5.0)\nÎ”Ï†      = deg2rad(4.0)\n\ndom = DomainInfo(t0, t1; levrange=1:72,\n                    lonrange = deg2rad(-130):Î”Î»:deg2rad(-60),\n                    latrange = deg2rad(25):Î”Ï†:deg2rad(61))\n\nmdl = couple(Puff(dom),\n             GEOSFP(\"4x5\", dom; stream=false),\n             GaussianSD())\n\nsys  = convert(System, mdl)\n\nu0 = [sys.Puffâ‚Šlon => deg2rad(-105),\n      sys.Puffâ‚Šlat => deg2rad(  38),\n      sys.Puffâ‚Šlev => 2,\n      sys.GaussianSDâ‚Šsigma_h => 0.0]\n\np = [\n        sys.GaussianSDâ‚ŠÎ”Î» => Î”Î»,\n        sys.GaussianSDâ‚ŠÎ”Ï† => Î”Ï†]\n\nprob = ODEProblem(sys, u0, (datetime2unix(t0), datetime2unix(t1)), p)\nsol = solve(prob, Tsit5();)\n\nsigma_h = sol[sys.GaussianSDâ‚Šsigma_h]\nC_gl    = sol[sys.GaussianSDâ‚ŠC_gl]\n\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.IdealGasLaw-Tuple{}","page":"API","title":"EnvironmentalTransport.IdealGasLaw","text":"IdealGasLaw(; name=:IdealGasLaw)\n\nCalculates air density from pressure and temperature using the ideal gas law.\n\nImplements Equation 1.2: rho = M_air * p / (R * T)\n\nwhere:\n\nrho: air density (kg/m^3)\nM_air: molecular weight of dry air (kg/mol)\np: atmospheric pressure (Pa)\nR: universal gas constant (J/(mol*K))\nT: temperature (K)\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.LocalScaleMeteorology-Tuple{}","page":"API","title":"EnvironmentalTransport.LocalScaleMeteorology","text":"LocalScaleMeteorology(; name=:LocalScaleMeteorology)\n\nReturns a ModelingToolkit.System combining atmospheric stability analysis with surface layer Monin-Obukhov similarity theory for comprehensive local-scale meteorological calculations.\n\nBased on Chapter 16 \"Meteorology of the Local Scale\" from Seinfeld & Pandis (2006) \"Atmospheric Chemistry and Physics\", 2nd Edition, pp. 720-760.\n\nThis composite system includes:\n\nPotential temperature and stability classification\nDry adiabatic lapse rate\nMonin-Obukhov length and stability parameter\nStability-corrected wind profiles\nPasquill stability class estimation (Table 16.4)\n\nKey equations:\n\nEq. 16.8: Î“ = g/Ä‰_p â‰ˆ 9.76 K/km (dry adiabatic lapse rate)\nEq. 16.14: Î¸ = T(pâ‚€/p)^0.286 (potential temperature)\nEq. 16.66: Å« = (u*/Îº)ln(z/zâ‚€) (log wind profile)\nEq. 16.70: L = -ÏÄ‰p Tâ‚€ u*Â³/(Îºg qÌ„z) (Monin-Obukhov length)\nEq. 16.75: Ï†m, Ï†h (Businger-Dyer stability functions)\nEq. 16.83: 1/L = a + bÂ·logâ‚â‚€(zâ‚€) (Golder correlation for Pasquill classes)\n\nPasquill Stability Classes (Table 16.4):\n\nA: Very unstable (strong convection)\nB: Moderately unstable\nC: Slightly unstable\nD: Neutral\nE: Slightly stable\nF: Moderately stable\nG: Very stable (strong inversion)\n\nExample:\n\nusing ModelingToolkit, EnvironmentalTransport\n\nmet = LocalScaleMeteorology()\nsys = mtkcompile(met)\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.MixingRatio-Tuple{}","page":"API","title":"EnvironmentalTransport.MixingRatio","text":"MixingRatio(; name=:MixingRatio)\n\nCalculates the volume (mole) mixing ratio of a species.\n\nImplements Equation 1.6: xii = ci / c_total\n\nThe mixing ratio is dimensionless and typically expressed in ppm, ppb, or ppt.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.PartialPressureMixingRatio-Tuple{}","page":"API","title":"EnvironmentalTransport.PartialPressureMixingRatio","text":"PartialPressureMixingRatio(; name=:PartialPressureMixingRatio)\n\nRelates mixing ratio to partial pressure.\n\nImplements Equation 1.8: xii = ci / (p/(R*T)) = p_i / p\n\nThe mixing ratio equals the ratio of partial pressure to total pressure.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.Puff-Tuple{EarthSciMLBase.DomainInfo}","page":"API","title":"EnvironmentalTransport.Puff","text":"Puff(\n    di::EarthSciMLBase.DomainInfo;\n    buffer_cells,\n    name\n) -> ModelingToolkit.System\n\n\nCreate a Lagrangian transport model which advects a \"puff\" or particle of matter within a fluid velocity field.\n\nModel boundaries are set by the DomainInfo argument. The model sets boundaries at the ground and model bottom and top, preventing the puff from crossing those boundaries. If the puff reaches one of the horizontal boundaries, the simulation is stopped.\n\nKeyword arguments\n\nbuffer_cells: The distance (expressed in a number of DomainInfo grid cells) to use as a buffer around the horizontal edge of the domain to avoid data loader interpolation errors. The effective size of the domain will be reduce by 2Ã— this amount (default = 1)\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.RelativeHumidity-Tuple{}","page":"API","title":"EnvironmentalTransport.RelativeHumidity","text":"RelativeHumidity(; name=:RelativeHumidity)\n\nCalculates relative humidity from water vapor partial pressure and saturation vapor pressure.\n\nImplements Equation 1.9: RH = 100 * pH2O / pH2O_sat\n\nRelative humidity is expressed as a percentage (0-100%), stored as a dimensionless ratio multiplied by 100.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.SaturationVaporPressure-Tuple{}","page":"API","title":"EnvironmentalTransport.SaturationVaporPressure","text":"SaturationVaporPressure(; name=:SaturationVaporPressure)\n\nCalculates the saturation vapor pressure of water as a function of temperature.\n\nImplements Equation 1.10: pH2Osat(T) = 1013.25 * exp(13.3185a - 1.9760a^2 - 0.6445a^3 - 0.1299a^4)\n\nwhere: a = 1 - 373.15/T\n\nThis empirical formula is valid for liquid water (T > 273 K).\n\nNote: The original equation gives pressure in mbar. Here we convert to Pa for consistency with SI units: psat (Pa) = 100 * psat (mbar)\n\nReference values:\n\nAt T = 273 K: p_sat ~ 611 Pa (6.1 mbar)\nAt T = 298 K: p_sat ~ 3170 Pa (31.7 mbar)\nAt T = 373 K: p_sat = 101325 Pa (1013.25 mbar, boiling point)\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.ScaleHeight-Tuple{}","page":"API","title":"EnvironmentalTransport.ScaleHeight","text":"ScaleHeight(; name=:ScaleHeight)\n\nCalculates the atmospheric scale height.\n\nImplements Equation 1.4: H = R * T / (M_air * g)\n\nThe scale height H represents the altitude increase over which pressure decreases by a factor of e (~2.718).\n\nTypical values:\n\nAt T = 253 K: H = 7.4 km\nAt T = 288 K (sea level): H = 8.4 km\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.Sofiev2012PlumeRise-Tuple{}","page":"API","title":"EnvironmentalTransport.Sofiev2012PlumeRise","text":"Wildfire plume rise model based on Sofiev et al. (2012) [1].\n\n[1] Sofiev, M., Ermakova, T., and Vankevich, R.: Evaluation of the smoke-injection height from wild-land fires using remote-sensing data, Atmos. Chem. Phys., 12, 1995â€“2006, https://doi.org/10.5194/acp-12-1995-2012, 2012.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.SurfaceLayerProfile-Tuple{}","page":"API","title":"EnvironmentalTransport.SurfaceLayerProfile","text":"SurfaceLayerProfile(; name=:SurfaceLayerProfile)\n\nReturns a ModelingToolkit.System implementing Monin-Obukhov similarity theory for the atmospheric surface layer, including logarithmic wind profiles and stability corrections.\n\nBased on Chapter 16 \"Meteorology of the Local Scale\" from Seinfeld & Pandis (2006) \"Atmospheric Chemistry and Physics\", 2nd Edition, pp. 720-760.\n\nKey equations implemented:\n\nEq. 16.66: Logarithmic wind profile Å«(z) = (u*/Îº)ln(z/zâ‚€)\nEq. 16.70: Monin-Obukhov length L = -ÏÄ‰p Tâ‚€ u*Â³/(Îºg qÌ„z)\nEq. 16.75: Businger-Dyer stability functions Ï†m, Ï†h\nEq. 16.78-16.79: Integrated stability functions Ïˆm, Ïˆh\n\nThe system computes:\n\nMean wind speed at height z with stability corrections\nFriction velocity u*\nSensible heat flux\nStability-corrected profiles for momentum and heat\n\nExample:\n\nusing ModelingToolkit, EnvironmentalTransport\n\nsurf = SurfaceLayerProfile()\nsys = mtkcompile(surf)\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.TotalMolarConcentration-Tuple{}","page":"API","title":"EnvironmentalTransport.TotalMolarConcentration","text":"TotalMolarConcentration(; name=:TotalMolarConcentration)\n\nCalculates total molar concentration of air from pressure and temperature.\n\nImplements Equation 1.7: c_total = N/V = p / (R * T)\n\nStandard values:\n\nAt STP (T=273.15 K, p=101325 Pa): c_total = 44.6 mol/m^3\nAt T=298 K, p=101325 Pa: c_total = 40.9 mol/m^3\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.WaterVaporThermodynamics-Tuple{}","page":"API","title":"EnvironmentalTransport.WaterVaporThermodynamics","text":"WaterVaporThermodynamics(; name=:WaterVaporThermodynamics)\n\nComplete water vapor thermodynamics system combining:\n\nEquation 1.10: Saturation vapor pressure\nEquation 1.9: Relative humidity\n\nThis composite system calculates relative humidity given temperature and water vapor partial pressure.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.advection_kernel_4d","page":"API","title":"EnvironmentalTransport.advection_kernel_4d","text":"An advection kernel for a 4D array, where the first dimension is the state variables and the next three dimensions are the spatial dimensions.\n\n\n\n\n\n","category":"function"},{"location":"api/#EnvironmentalTransport.advection_op-Tuple{Any, Any, Any, Any, Any, Any, EarthSciMLBase.MapAlgorithm}","page":"API","title":"EnvironmentalTransport.advection_op","text":"A function to create an advection operator for a 4D array,\n\nArguments:\n\nu_prototype: A prototype array of the same size and type as the input array.\nstencil: The stencil operator, e.g. l94_stencil or ppm_stencil.\nv_fs: A vector of functions to get the wind velocity at a given place and time. The function signature should be v_fs(i, j, k, t).\nÎ”_fs: A vector of functions to get the grid spacing at a given place and time. The function signature should be Î”_fs(i, j, k, t).\nÎ”t: The time step size, which is assumed to be fixed.\nbc_type: The boundary condition type, e.g. ZeroGradBC().\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.get_vf-Tuple{Any, AbstractString, Any}","page":"API","title":"EnvironmentalTransport.get_vf","text":"get_vf(domain, varname, data_f)\n\n\nReturn a function that gets the wind velocity at a given place and time for the given varname. data_f should be a function that takes a time and three spatial coordinates and returns the value of the wind speed in the direction indicated by varname.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.get_Î”-Tuple{EarthSciMLBase.DomainInfo, Any, Any}","page":"API","title":"EnvironmentalTransport.get_Î”","text":"get_Î”(domain, tff, pvaridx)\n\n\nReturn a function that gets the grid spacing at a given place and time for the given varname.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.stencil_size-Tuple{typeof(upwind1_stencil)}","page":"API","title":"EnvironmentalTransport.stencil_size","text":"Return the left and right stencil size of the first-order upwind stencil.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.upwind1_stencil-NTuple{4, Any}","page":"API","title":"EnvironmentalTransport.upwind1_stencil","text":"upwind1_stencil(Ï•, U, Î”t, Î”z; p)\n\n\nFirst-order upwind advection in 1-D: https://en.wikipedia.org/wiki/Upwind_scheme.\n\nÏ• is the scalar field at the current time step, it should be a vector of length 3 (1 cell on the left, the central cell, and 1 cell on the right).\nU is the velocity at both edges of the central grid cell, it should be a vector of length 2.\nÎ”t is the length of the time step.\nÎ”z is the grid spacing.\n\nThe output will be time derivative of the central index (i.e. index 2) of the Ï• vector (i.e. dÏ•/dt).\n\nÎ”t and p are not used, but are function arguments for consistency with other operators.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.vf_x-Tuple{Any, Any}","page":"API","title":"EnvironmentalTransport.vf_x","text":"Get a value from the x-direction velocity field.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.vf_y-Tuple{Any, Any}","page":"API","title":"EnvironmentalTransport.vf_y","text":"Get a value from the y-direction velocity field.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.vf_z-Tuple{Any, Any}","page":"API","title":"EnvironmentalTransport.vf_z","text":"Get a value from the z-direction velocity field.\n\n\n\n\n\n","category":"method"},{"location":"api/#EnvironmentalTransport.Î”f-Tuple{Any, Any}","page":"API","title":"EnvironmentalTransport.Î”f","text":"function to get grid deltas.\n\n\n\n\n\n","category":"method"},{"location":"local_scale_meteorology/#Local-Scale-Meteorology","page":"Local Scale Meteorology","title":"Local Scale Meteorology","text":"","category":"section"},{"location":"local_scale_meteorology/#Overview","page":"Local Scale Meteorology","title":"Overview","text":"This module implements equations for local-scale atmospheric boundary layer meteorology, including:\n\nAtmospheric stability classification based on potential temperature\nMonin-Obukhov similarity theory for the surface layer\nLogarithmic wind profiles with stability corrections\nPasquill stability class estimation\n\nThese equations are essential for understanding pollutant dispersion in the atmospheric boundary layer, where turbulent mixing is driven by mechanical (wind shear) and thermal (buoyancy) effects.\n\nReference: Seinfeld, J.H. and Pandis, S.N. (2006) Atmospheric Chemistry and Physics: From Air Pollution to Climate Change, 2nd Edition, Chapter 16: \"Meteorology of the Local Scale\", pp. 720-760. John Wiley & Sons.","category":"section"},{"location":"local_scale_meteorology/#Implementation","page":"Local Scale Meteorology","title":"Implementation","text":"The implementation consists of three main systems:\n\nAtmosphericStability: Computes potential temperature and vertical stability based on temperature gradients\nSurfaceLayerProfile: Implements Monin-Obukhov similarity theory for wind profiles\nLocalScaleMeteorology: A comprehensive system combining both stability and wind profile calculations","category":"section"},{"location":"local_scale_meteorology/#State-Variables","page":"Local Scale Meteorology","title":"State Variables","text":"using DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing EnvironmentalTransport\n\nsys = LocalScaleMeteorology()\nvars = unknowns(sys)\n\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [ModelingToolkit.get_unit(v) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"local_scale_meteorology/#Parameters","page":"Local Scale Meteorology","title":"Parameters","text":"params = parameters(sys)\n\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Default => [ModelingToolkit.getdefault(p) for p in params],\n    :Units => [ModelingToolkit.get_unit(p) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"local_scale_meteorology/#Equations","page":"Local Scale Meteorology","title":"Equations","text":"eqs = equations(sys)","category":"section"},{"location":"local_scale_meteorology/#Analysis","page":"Local Scale Meteorology","title":"Analysis","text":"","category":"section"},{"location":"local_scale_meteorology/#Dry-Adiabatic-Lapse-Rate-(Eq.-16.8)","page":"Local Scale Meteorology","title":"Dry Adiabatic Lapse Rate (Eq. 16.8)","text":"A key result from the first law of thermodynamics applied to an adiabatically rising air parcel is the dry adiabatic lapse rate:\n\nGamma = fracghatc_ptextair = frac9807 text ms^21005 text J(kgK) approx 976 text Kkm\n\nThis represents the rate at which an unsaturated air parcel cools as it rises adiabatically.\n\n# Verify the dry adiabatic lapse rate calculation\ng = 9.807  # m/sÂ²\nÄ‰_p = 1005.0  # J/(kgÂ·K)\nÎ“ = g / Ä‰_p * 1000  # Convert to K/km\nprintln(\"Dry adiabatic lapse rate: Î“ = $(round(Î“, digits=2)) K/km\")","category":"section"},{"location":"local_scale_meteorology/#Potential-Temperature-(Eq.-16.14)","page":"Local Scale Meteorology","title":"Potential Temperature (Eq. 16.14)","text":"Potential temperature is the temperature an air parcel would have if brought adiabatically to a reference pressure (typically sea level):\n\ntheta = T left(fracp_0pright)^R(c_p M_textair) = T left(fracp_0pright)^0286\n\nusing OrdinaryDiffEqDefault, Plots\ndefault(size = (700, 400))\n\nsys = LocalScaleMeteorology()\ncsys = mtkcompile(sys)\n\n# Calculate potential temperature at different pressure levels\npressures = range(101325, 50000, length = 20)  # Pa\nT_ambient = 288.15 .- 0.0065 .* (1 .- pressures ./ 101325) .* 8500  # Approximate T profile\n\nÎ¸_values = Float64[]\nfor (p, T) in zip(pressures, T_ambient)\n    prob = ODEProblem(csys, Dict(), (0.0, 1.0), Dict(csys.T => T, csys.p => p))\n    sol = solve(prob)\n    push!(Î¸_values, sol[csys.Î¸][end])\nend\n\nplot(Î¸_values, pressures ./ 100,\n    xlabel = \"Potential Temperature (K)\",\n    ylabel = \"Pressure (hPa)\",\n    yflip = true,\n    label = \"Î¸\",\n    linewidth = 2,\n    title = \"Potential Temperature Profile\")","category":"section"},{"location":"local_scale_meteorology/#Atmospheric-Stability-Classification","page":"Local Scale Meteorology","title":"Atmospheric Stability Classification","text":"Atmospheric stability determines the tendency of vertically displaced air parcels to return to equilibrium or continue moving. The stability is characterized by the potential temperature gradient:\n\nStable (partialthetapartial z  0): Displaced parcels return to original position\nNeutral (partialthetapartial z = 0): Displaced parcels remain at new position\nUnstable (partialthetapartial z  0): Displaced parcels accelerate away\n\nsys = AtmosphericStability()\ncsys = mtkcompile(sys)\n\nT_surface = 288.15  # K\nÎ”z = 100.0  # m\n\n# Three stability cases\ncases = [\n    (\"Stable (weak lapse)\", T_surface - 0.005 * Î”z),      # 0.5 K/100m\n    (\"Neutral (adiabatic)\", T_surface - 0.00976 * Î”z),    # ~9.76 K/km\n    (\"Unstable (superadiabatic)\", T_surface - 0.015 * Î”z)  # 1.5 K/100m\n]\n\nresults = []\nfor (label, T_above) in cases\n    prob = ODEProblem(csys, Dict(), (0.0, 1.0),\n        Dict(csys.T => T_above, csys.T_below => T_surface, csys.Î”z => Î”z))\n    sol = solve(prob)\n    push!(results, (label = label, S = sol[csys.S][end] * 1000))  # K/km\nend\n\nDataFrame(results)","category":"section"},{"location":"local_scale_meteorology/#Monin-Obukhov-Similarity-Theory","page":"Local Scale Meteorology","title":"Monin-Obukhov Similarity Theory","text":"The Monin-Obukhov length L is a fundamental scaling parameter that characterizes the relative importance of mechanical and thermal turbulence production:\n\nL = -fracrho hatc_p T_0 u_*^3kappa g barq_z\n\nwhere:\n\nu_* is the friction velocity\nbarq_z is the surface sensible heat flux\nkappa = 04 is the von Karman constant\n\nsys = SurfaceLayerProfile()\ncsys = mtkcompile(sys)\n\n# Calculate Monin-Obukhov length for different heat flux conditions\nheat_fluxes = range(-100, 200, length = 50)  # W/mÂ²\nL_values = Float64[]\n\nfor q in heat_fluxes\n    if abs(q) < 1e-6\n        push!(L_values, NaN)  # Avoid singularity\n        continue\n    end\n    prob = ODEProblem(csys, Dict(), (0.0, 1.0),\n        Dict(csys.u_star => 0.3, csys.q_z => q))\n    sol = solve(prob)\n    L_val = sol[csys.L][end]\n    push!(L_values, clamp(L_val, -500, 500))  # Clamp for visualization\nend\n\nplot(heat_fluxes, L_values,\n    xlabel = \"Surface Heat Flux (W/mÂ²)\",\n    ylabel = \"Monin-Obukhov Length L (m)\",\n    label = \"L\",\n    linewidth = 2,\n    title = \"Monin-Obukhov Length vs Heat Flux\\n(u* = 0.3 m/s)\",\n    ylims = (-500, 500))\nhline!([0], linestyle = :dash, color = :gray, label = \"\")\nvline!([0], linestyle = :dash, color = :gray, label = \"\")\nannotate!([(100, -200, text(\"Unstable\\n(L < 0)\", 8)),\n    (-50, 200, text(\"Stable\\n(L > 0)\", 8))])","category":"section"},{"location":"local_scale_meteorology/#Businger-Dyer-Stability-Functions-(Eq.-16.75)","page":"Local Scale Meteorology","title":"Businger-Dyer Stability Functions (Eq. 16.75)","text":"The universal functions phi_m(zeta) and phi_h(zeta) describe how momentum and heat transfer deviate from neutral conditions:\n\nUnstable (zeta  0):\n\nphi_m = (1 - 15zeta)^-14 quad phi_h = (1 - 15zeta)^-12\n\nStable (zeta  0):\n\nphi_m = phi_h = 1 + 47zeta\n\n# Plot stability functions\nÎ¶_unstable = range(-2, 0, length = 50)\nÎ¶_stable = range(0, 2, length = 50)\nÎ¶_all = vcat(Î¶_unstable, Î¶_stable)\n\nÏ†_m_unstable = (1 .- 15 .* Î¶_unstable) .^ (-0.25)\nÏ†_m_stable = 1 .+ 4.7 .* Î¶_stable\nÏ†_m_all = vcat(Ï†_m_unstable, Ï†_m_stable)\n\nÏ†_h_unstable = (1 .- 15 .* Î¶_unstable) .^ (-0.5)\nÏ†_h_stable = 1 .+ 4.7 .* Î¶_stable\nÏ†_h_all = vcat(Ï†_h_unstable, Ï†_h_stable)\n\nplot(Î¶_all, Ï†_m_all, label = \"Ï†_m (momentum)\", linewidth = 2)\nplot!(Î¶_all, Ï†_h_all, label = \"Ï†_h (heat)\", linewidth = 2)\nxlabel!(\"Î¶ = z/L\")\nylabel!(\"Ï†\")\ntitle!(\"Businger-Dyer Stability Functions (Eq. 16.75)\")\nhline!([1], linestyle = :dash, color = :gray, label = \"Neutral\")\nvline!([0], linestyle = :dash, color = :gray, label = \"\")","category":"section"},{"location":"local_scale_meteorology/#Logarithmic-Wind-Profile-(Eq.-16.66)","page":"Local Scale Meteorology","title":"Logarithmic Wind Profile (Eq. 16.66)","text":"The wind velocity in the surface layer follows a logarithmic profile with stability corrections:\n\nbaru(z) = fracu_*kappaleftlnleft(fraczz_0right) - psi_m(zeta)right\n\nwhere psi_m is the integrated stability function.\n\nsys = SurfaceLayerProfile()\ncsys = mtkcompile(sys)\n\n# Wind profiles for different stability conditions\nheights = range(1, 50, length = 30)  # m\nzâ‚€ = 0.1  # m\nu_star = 0.4  # m/s\n\n# Neutral, stable, and unstable profiles\nstabilities = [\n    (\"Neutral\", 1e-8),\n    (\"Stable\", -50.0),  # Negative flux = downward = stable\n    (\"Unstable\", 100.0)  # Positive flux = upward = unstable\n]\n\np = plot(\n    title = \"Wind Profiles for Different Stability Conditions\\n(u* = 0.4 m/s, zâ‚€ = 0.1 m)\",\n    xlabel = \"Wind Speed (m/s)\", ylabel = \"Height (m)\")\n\nfor (label, q_z) in stabilities\n    u_values = Float64[]\n    for z in heights\n        prob = ODEProblem(csys, Dict(), (0.0, 1.0),\n            Dict(csys.z => z, csys.zâ‚€ => zâ‚€, csys.u_star => u_star, csys.q_z => q_z))\n        sol = solve(prob)\n        push!(u_values, sol[csys.Å«][end])\n    end\n    plot!(p, u_values, heights, label = label, linewidth = 2)\nend\np","category":"section"},{"location":"local_scale_meteorology/#Pasquill-Stability-Classes-(Table-16.4)","page":"Local Scale Meteorology","title":"Pasquill Stability Classes (Table 16.4)","text":"The Pasquill-Gifford stability classification provides a practical way to categorize atmospheric stability based on observable meteorological conditions:\n\nClass Description Conditions\nA Very unstable Strong daytime insolation, light winds\nB Moderately unstable Moderate daytime insolation\nC Slightly unstable Weak daytime insolation\nD Neutral Overcast or high winds\nE Slightly stable Night, partial cloud cover\nF Moderately stable Night, clear skies, light winds\n\nThe Golder (1972) correlation relates Pasquill classes to Monin-Obukhov length via:\n\nfrac1L = a + b cdot log_10(z_0)\n\n# Golder correlation coefficients\ngolder_params = [\n    (\"A\", -0.096, 0.029),\n    (\"B\", -0.037, 0.029),\n    (\"C\", -0.002, 0.018),\n    (\"D\", 0.000, 0.000),\n    (\"E\", 0.004, -0.018),\n    (\"F\", 0.035, -0.036)\n]\n\nz0_range = 10 .^ range(-4, 1, length = 100)  # m\n\np = plot(\n    title = \"Monin-Obukhov Length vs Roughness Length\\nfor Pasquill Stability Classes (Eq. 16.83)\",\n    xlabel = \"Roughness Length zâ‚€ (m)\", ylabel = \"1/L (mâ»Â¹)\",\n    xscale = :log10, legend = :topright)\n\nfor (class, a, b) in golder_params\n    L_inv = a .+ b .* log10.(z0_range)\n    plot!(p, z0_range, L_inv, label = \"Class $class\", linewidth = 2)\nend\nhline!([0], linestyle = :dash, color = :gray, label = \"Neutral\")\nylims!(-0.15, 0.1)\np","category":"section"},{"location":"local_scale_meteorology/#Example:-Complete-Boundary-Layer-Analysis","page":"Local Scale Meteorology","title":"Example: Complete Boundary Layer Analysis","text":"sys = LocalScaleMeteorology()\ncsys = mtkcompile(sys)\n\n# Summer afternoon conditions\nconditions = Dict(\n    csys.T => 298.15,        # 25Â°C at 10m\n    csys.T_below => 300.15,  # 27Â°C at surface (superadiabatic)\n    csys.p => 100000.0,      # ~sea level\n    csys.z => 10.0,          # 10m measurement height\n    csys.zâ‚€ => 0.1,          # Grassland\n    csys.Î”z => 10.0,         # 10m vertical spacing\n    csys.Tâ‚€ => 300.15,       # Surface temperature\n    csys.Ï => 1.18,          # Air density\n    csys.u_star => 0.35,     # Moderate friction\n    csys.q_z => 150.0        # Strong upward heat flux (sunny afternoon)\n)\n\nprob = ODEProblem(csys, Dict(), (0.0, 1.0), conditions)\nsol = solve(prob)\n\nprintln(\"=== Summer Afternoon Boundary Layer Analysis ===\\n\")\nprintln(\"Potential temperature: Î¸ = $(round(sol[csys.Î¸][end], digits=1)) K\")\nprintln(\"Stability (dÎ¸/dz): $(round(sol[csys.dÎ¸_dz][end] * 1000, digits=2)) K/km\")\nprintln(\"Monin-Obukhov length: L = $(round(sol[csys.L][end], digits=1)) m\")\nprintln(\"Stability parameter: Î¶ = $(round(sol[csys.Î¶][end], digits=3))\")\nprintln(\"Wind speed at 10m: Å« = $(round(sol[csys.Å«][end], digits=2)) m/s\")\nprintln(\"Pasquill class: $(Int(round(sol[csys.pasquill_class][end]))) (1=A to 6=F)\")\n\n# Interpret the results\nL_val = sol[csys.L][end]\nstability = L_val < 0 ? \"UNSTABLE\" : (L_val > 0 ? \"STABLE\" : \"NEUTRAL\")\nprintln(\"\\nInterpretation: Atmosphere is $stability (typical for sunny afternoon)\")","category":"section"},{"location":"local_scale_meteorology/#Roughness-Length-Reference-(Table-16.1)","page":"Local Scale Meteorology","title":"Roughness Length Reference (Table 16.1)","text":"The roughness length z_0 depends on surface characteristics:\n\nSurface Type zâ‚€ (m)\nVery smooth (ice, mud flats) 10â»âµ\nSnow, smooth sea, level desert 10â»Â³\nLawn 10â»Â²\nUncut grass 0.05\nFull-grown root crops 0.1\nTree-covered terrain 1\nLow-density residential 2\nCentral business district 5-10","category":"section"},{"location":"local_scale_meteorology/#EnvironmentalTransport.LocalScaleMeteorology","page":"Local Scale Meteorology","title":"EnvironmentalTransport.LocalScaleMeteorology","text":"LocalScaleMeteorology(; name=:LocalScaleMeteorology)\n\nReturns a ModelingToolkit.System combining atmospheric stability analysis with surface layer Monin-Obukhov similarity theory for comprehensive local-scale meteorological calculations.\n\nBased on Chapter 16 \"Meteorology of the Local Scale\" from Seinfeld & Pandis (2006) \"Atmospheric Chemistry and Physics\", 2nd Edition, pp. 720-760.\n\nThis composite system includes:\n\nPotential temperature and stability classification\nDry adiabatic lapse rate\nMonin-Obukhov length and stability parameter\nStability-corrected wind profiles\nPasquill stability class estimation (Table 16.4)\n\nKey equations:\n\nEq. 16.8: Î“ = g/Ä‰_p â‰ˆ 9.76 K/km (dry adiabatic lapse rate)\nEq. 16.14: Î¸ = T(pâ‚€/p)^0.286 (potential temperature)\nEq. 16.66: Å« = (u*/Îº)ln(z/zâ‚€) (log wind profile)\nEq. 16.70: L = -ÏÄ‰p Tâ‚€ u*Â³/(Îºg qÌ„z) (Monin-Obukhov length)\nEq. 16.75: Ï†m, Ï†h (Businger-Dyer stability functions)\nEq. 16.83: 1/L = a + bÂ·logâ‚â‚€(zâ‚€) (Golder correlation for Pasquill classes)\n\nPasquill Stability Classes (Table 16.4):\n\nA: Very unstable (strong convection)\nB: Moderately unstable\nC: Slightly unstable\nD: Neutral\nE: Slightly stable\nF: Moderately stable\nG: Very stable (strong inversion)\n\nExample:\n\nusing ModelingToolkit, EnvironmentalTransport\n\nmet = LocalScaleMeteorology()\nsys = mtkcompile(met)\n\n\n\n\n\n","category":"function"},{"location":"local_scale_meteorology/#EnvironmentalTransport.AtmosphericStability","page":"Local Scale Meteorology","title":"EnvironmentalTransport.AtmosphericStability","text":"AtmosphericStability(; name=:AtmosphericStability)\n\nReturns a ModelingToolkit.System that computes atmospheric stability parameters including potential temperature, dry adiabatic lapse rate, and stability classification.\n\nBased on Chapter 16 \"Meteorology of the Local Scale\" from Seinfeld & Pandis (2006) \"Atmospheric Chemistry and Physics\", 2nd Edition, pp. 720-760.\n\nKey equations implemented:\n\nEq. 16.8: Dry adiabatic lapse rate Î“ = g/Ä‰_p â‰ˆ 9.76 K/km\nEq. 16.14: Potential temperature Î¸ = T(pâ‚€/p)^(R/Ä‰_p)\nEq. 16.16-16.18: Stability classification based on âˆ‚Î¸/âˆ‚z\n\nThe stability parameter S indicates:\n\nS > 0: Stable atmosphere (âˆ‚Î¸/âˆ‚z > 0)\nS = 0: Neutral atmosphere (âˆ‚Î¸/âˆ‚z = 0)\nS < 0: Unstable atmosphere (âˆ‚Î¸/âˆ‚z < 0)\n\nExample:\n\nusing ModelingToolkit, EnvironmentalTransport\n\nstab = AtmosphericStability()\nsys = mtkcompile(stab)\n\n\n\n\n\n","category":"function"},{"location":"local_scale_meteorology/#EnvironmentalTransport.SurfaceLayerProfile","page":"Local Scale Meteorology","title":"EnvironmentalTransport.SurfaceLayerProfile","text":"SurfaceLayerProfile(; name=:SurfaceLayerProfile)\n\nReturns a ModelingToolkit.System implementing Monin-Obukhov similarity theory for the atmospheric surface layer, including logarithmic wind profiles and stability corrections.\n\nBased on Chapter 16 \"Meteorology of the Local Scale\" from Seinfeld & Pandis (2006) \"Atmospheric Chemistry and Physics\", 2nd Edition, pp. 720-760.\n\nKey equations implemented:\n\nEq. 16.66: Logarithmic wind profile Å«(z) = (u*/Îº)ln(z/zâ‚€)\nEq. 16.70: Monin-Obukhov length L = -ÏÄ‰p Tâ‚€ u*Â³/(Îºg qÌ„z)\nEq. 16.75: Businger-Dyer stability functions Ï†m, Ï†h\nEq. 16.78-16.79: Integrated stability functions Ïˆm, Ïˆh\n\nThe system computes:\n\nMean wind speed at height z with stability corrections\nFriction velocity u*\nSensible heat flux\nStability-corrected profiles for momentum and heat\n\nExample:\n\nusing ModelingToolkit, EnvironmentalTransport\n\nsurf = SurfaceLayerProfile()\nsys = mtkcompile(surf)\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#Atmospheric-Fundamentals","page":"Atmospheric Fundamentals","title":"Atmospheric Fundamentals","text":"","category":"section"},{"location":"seinfeld_pandis_ch1/#Overview","page":"Atmospheric Fundamentals","title":"Overview","text":"This module implements the fundamental atmospheric equations from Chapter 1 of Seinfeld and Pandis (2006). These equations describe the basic physical and thermodynamic properties of Earth's atmosphere, including pressure distribution, temperature profiles, and concentration units. They form the foundation for atmospheric chemistry and physics modeling.\n\nThe implementation provides ModelingToolkit.jl components for:\n\nHydrostatic equilibrium: The vertical pressure gradient in the atmosphere (Eq. 1.1)\nIdeal gas law: Air density from pressure and temperature (Eq. 1.2)\nScale height: Characteristic altitude for pressure decrease (Eq. 1.4)\nBarometric formula: Pressure-altitude relationship for isothermal atmosphere (Eq. 1.5)\nConcentration units: Volume mixing ratio and molar concentration (Eq. 1.6-1.8)\nWater vapor: Saturation vapor pressure and relative humidity (Eq. 1.9-1.10)\n\nReference: Seinfeld, J.H. and Pandis, S.N. (2006). Atmospheric Chemistry and Physics: From Air Pollution to Climate Change, 2nd Edition, Chapter 1: The Atmosphere. John Wiley & Sons, Inc.","category":"section"},{"location":"seinfeld_pandis_ch1/#Implementation","page":"Atmospheric Fundamentals","title":"Implementation","text":"using EnvironmentalTransport\nusing DataFrames, ModelingToolkit, Symbolics, DynamicQuantities\nusing ModelingToolkit: @named\nnothing # hide","category":"section"},{"location":"seinfeld_pandis_ch1/#Ideal-Gas-Law-(Eq.-1.2)","page":"Atmospheric Fundamentals","title":"Ideal Gas Law (Eq. 1.2)","text":"The ideal gas law relates air density to pressure and temperature:\n\nrho = fracM_air cdot pR cdot T","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = IdealGasLaw()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Scale-Height-(Eq.-1.4)","page":"Atmospheric Fundamentals","title":"Scale Height (Eq. 1.4)","text":"The scale height represents the altitude increase over which pressure decreases by a factor of e (~2.718):\n\nH = fracR cdot TM_air cdot g","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-2","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = ScaleHeight()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-2","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Atmospheric-Pressure-Profile-(Eq.-1.1,-1.3,-1.5)","page":"Atmospheric Fundamentals","title":"Atmospheric Pressure Profile (Eq. 1.1, 1.3, 1.5)","text":"This component combines the hydrostatic equation with the ideal gas law to compute the complete atmospheric pressure profile.\n\nHydrostatic equation (Eq. 1.1):\n\nfracdpdz = -rho cdot g\n\nCombined form (Eq. 1.3):\n\nfracdpdz = -fracM_air cdot g cdot pR cdot T\n\nBarometric formula for isothermal atmosphere (Eq. 1.5):\n\nfracp(z)p_0 = expleft(-fraczHright)","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-3","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = AtmosphericPressureProfile()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Parameters","page":"Atmospheric Fundamentals","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [string(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-3","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Total-Molar-Concentration-(Eq.-1.7)","page":"Atmospheric Fundamentals","title":"Total Molar Concentration (Eq. 1.7)","text":"c_total = fracNV = fracpR cdot T","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-4","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = TotalMolarConcentration()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-4","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Mixing-Ratio-(Eq.-1.6)","page":"Atmospheric Fundamentals","title":"Mixing Ratio (Eq. 1.6)","text":"xi_i = fracc_ic_total","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-5","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = MixingRatio()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-5","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Partial-Pressure-Mixing-Ratio-(Eq.-1.8)","page":"Atmospheric Fundamentals","title":"Partial Pressure Mixing Ratio (Eq. 1.8)","text":"xi_i = fracp_ip","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-6","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = PartialPressureMixingRatio()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-6","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Saturation-Vapor-Pressure-(Eq.-1.10)","page":"Atmospheric Fundamentals","title":"Saturation Vapor Pressure (Eq. 1.10)","text":"p_H_2Osat(T) = p_std cdot exp(133185a - 19760a^2 - 06445a^3 - 01299a^4)\n\nwhere a = 1 - 37315T.","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-7","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = SaturationVaporPressure()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-7","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Relative-Humidity-(Eq.-1.9)","page":"Atmospheric Fundamentals","title":"Relative Humidity (Eq. 1.9)","text":"RH = 100 cdot fracp_H_2Op_H_2Osat","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-8","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = RelativeHumidity()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-8","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Composite:-Atmospheric-Thermodynamics","page":"Atmospheric Fundamentals","title":"Composite: Atmospheric Thermodynamics","text":"Combines Equations 1.2, 1.4, 1.5, and 1.7 for complete atmospheric thermodynamic properties at a given altitude and temperature.","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-9","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = AtmosphericThermodynamics()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Parameters-2","page":"Atmospheric Fundamentals","title":"Parameters","text":"params = parameters(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(p, escape = false)) for p in params],\n    :Units => [string(ModelingToolkit.get_unit(p)) for p in params],\n    :Description => [ModelingToolkit.getdescription(p) for p in params]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-9","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Composite:-Water-Vapor-Thermodynamics","page":"Atmospheric Fundamentals","title":"Composite: Water Vapor Thermodynamics","text":"Combines the saturation vapor pressure (Eq. 1.10) and relative humidity (Eq. 1.9) systems.","category":"section"},{"location":"seinfeld_pandis_ch1/#State-Variables-10","page":"Atmospheric Fundamentals","title":"State Variables","text":"@named sys = WaterVaporThermodynamics()\nvars = unknowns(sys)\nDataFrame(\n    :Name => [string(Symbolics.tosymbol(v, escape = false)) for v in vars],\n    :Units => [string(ModelingToolkit.get_unit(v)) for v in vars],\n    :Description => [ModelingToolkit.getdescription(v) for v in vars]\n)","category":"section"},{"location":"seinfeld_pandis_ch1/#Equations-10","page":"Atmospheric Fundamentals","title":"Equations","text":"equations(sys)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Analysis","page":"Atmospheric Fundamentals","title":"Analysis","text":"This section validates the implementation by reproducing key results from Seinfeld and Pandis (2006) Chapter 1.","category":"section"},{"location":"seinfeld_pandis_ch1/#U.S.-Standard-Atmosphere-Validation-(Table-1.4)","page":"Atmospheric Fundamentals","title":"U.S. Standard Atmosphere Validation (Table 1.4)","text":"Table 1.4 in the textbook provides properties of the U.S. Standard Atmosphere at various altitudes. We validate the barometric formula and ideal gas law by comparing calculated values with the reference data.\n\nusing Plots\n\n# Physical constants (same values used in the implementation)\nR_val = 8.314          # J/(mol*K)\nM_air_val = 0.02897    # kg/mol\ng_val = 9.807          # m/s^2\np_0_val = 101325.0     # Pa\n\n# U.S. Standard Atmosphere data (Table 1.4)\nus_std_atm = DataFrame(\n    :Altitude_km => [0, 5, 10, 15, 20, 25, 30, 40, 50],\n    :Temperature_K => [288.2, 255.7, 223.3, 216.7, 216.7, 221.6, 226.5, 250.4, 270.7],\n    :Pressure_mbar => [1013.0, 540.5, 265.0, 121.1, 55.29, 25.49, 11.97, 2.871, 0.798],\n    :Density_kg_m3 => [\n        1.225, 0.736, 0.414, 0.195, 0.0889, 0.0401, 0.0184, 0.00400, 0.00103]\n)\nus_std_atm","category":"section"},{"location":"seinfeld_pandis_ch1/#Pressure-Profile-Comparison","page":"Atmospheric Fundamentals","title":"Pressure Profile Comparison","text":"# Calculate pressure using barometric formula with local scale height\nfunction calc_pressure_variable_H(z_km, T_K)\n    z = z_km * 1000.0\n    H = R_val * T_K / (M_air_val * g_val)\n    return p_0_val * exp(-z / H) / 100  # Convert to mbar\nend\n\ncalculated_p = [calc_pressure_variable_H(z, T)\n                for (z, T) in\n                    zip(us_std_atm.Altitude_km, us_std_atm.Temperature_K)]\n\ncomparison = DataFrame(\n    :Altitude_km => us_std_atm.Altitude_km,\n    :Ref_Pressure_mbar => us_std_atm.Pressure_mbar,\n    :Calc_Pressure_mbar => round.(calculated_p, digits = 2),\n    :Error_percent => round.(\n        100 .* (calculated_p .- us_std_atm.Pressure_mbar) ./ us_std_atm.Pressure_mbar,\n        digits = 1\n    )\n)\ncomparison","category":"section"},{"location":"seinfeld_pandis_ch1/#Density-Profile-Comparison","page":"Atmospheric Fundamentals","title":"Density Profile Comparison","text":"function calc_density(p_mbar, T_K)\n    p_Pa = p_mbar * 100\n    return M_air_val * p_Pa / (R_val * T_K)\nend\n\ncalculated_rho = [calc_density(p, T)\n                  for (p, T) in\n                      zip(us_std_atm.Pressure_mbar, us_std_atm.Temperature_K)]\n\ndensity_comparison = DataFrame(\n    :Altitude_km => us_std_atm.Altitude_km,\n    :Ref_Density_kg_m3 => us_std_atm.Density_kg_m3,\n    :Calc_Density_kg_m3 => round.(calculated_rho, digits = 4),\n    :Error_percent => round.(\n        100 .* (calculated_rho .- us_std_atm.Density_kg_m3) ./ us_std_atm.Density_kg_m3,\n        digits = 1\n    )\n)\ndensity_comparison\n\nThe density calculation matches Table 1.4 values within 1%, validating the ideal gas law implementation (Eq. 1.2).\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Pressure-Altitude-Profile-(Figure)","page":"Atmospheric Fundamentals","title":"Pressure-Altitude Profile (Figure)","text":"This figure shows the exponential decrease of atmospheric pressure with altitude, comparing the isothermal barometric formula with U.S. Standard Atmosphere data.\n\nz_range = 0:0.5:50  # km\n\n# Isothermal atmosphere at T = 253 K (H = 7.4 km)\nH_253 = R_val * 253 / (M_air_val * g_val)\np_253 = [p_0_val * exp(-z * 1000 / H_253) / 100 for z in z_range]\n\n# Isothermal atmosphere at T = 288 K (H = 8.4 km)\nH_288 = R_val * 288 / (M_air_val * g_val)\np_288 = [p_0_val * exp(-z * 1000 / H_288) / 100 for z in z_range]\n\np1 = plot(;\n    xlabel = \"Altitude (km)\",\n    ylabel = \"Pressure (mbar)\",\n    title = \"Atmospheric Pressure vs Altitude\",\n    legend = :topright,\n    yscale = :log10,\n    ylims = (0.1, 2000),\n    size = (700, 500),\n    grid = true\n)\n\nplot!(p1, z_range, p_253;\n    label = \"Isothermal T = 253 K (H = 7.4 km)\",\n    linewidth = 2,\n    color = :blue,\n    linestyle = :dash)\n\nplot!(p1, z_range, p_288;\n    label = \"Isothermal T = 288 K (H = 8.4 km)\",\n    linewidth = 2,\n    color = :red,\n    linestyle = :dash)\n\nscatter!(p1, us_std_atm.Altitude_km, us_std_atm.Pressure_mbar;\n    label = \"U.S. Standard Atmosphere\",\n    markersize = 8,\n    color = :black)\n\np1\n\nThe U.S. Standard Atmosphere data falls between the two isothermal curves because the real atmosphere has a temperature profile that varies with altitude.\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Scale-Height-Variation-(Figure)","page":"Atmospheric Fundamentals","title":"Scale Height Variation (Figure)","text":"The scale height depends on temperature and determines how quickly pressure decreases with altitude.\n\nT_range = 200:5:320\nH_values = [R_val * T / (M_air_val * g_val) / 1000 for T in T_range]  # km\n\np2 = plot(\n    T_range, H_values;\n    xlabel = \"Temperature (K)\",\n    ylabel = \"Scale Height (km)\",\n    title = \"Atmospheric Scale Height vs Temperature (Eq. 1.4)\",\n    legend = false,\n    linewidth = 2,\n    color = :blue,\n    size = (600, 400),\n    grid = true\n)\n\nscatter!(p2, [253, 288, 216.7],\n    [R_val * 253 / (M_air_val * g_val) / 1000,\n        R_val * 288 / (M_air_val * g_val) / 1000,\n        R_val * 216.7 / (M_air_val * g_val) / 1000];\n    markersize = 10,\n    color = :red,\n    label = nothing)\n\nannotate!(p2, 253, 7.0, text(\"Troposphere\\n(253 K)\", 8, :center))\nannotate!(p2, 288, 9.0, text(\"Sea level\\n(288 K)\", 8, :center))\nannotate!(p2, 216.7, 8.0, text(\"Tropopause\\n(217 K)\", 8, :center))\n\np2\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Saturation-Vapor-Pressure-of-Water-(Figure)","page":"Atmospheric Fundamentals","title":"Saturation Vapor Pressure of Water (Figure)","text":"This figure reproduces the saturation vapor pressure curve from Equation 1.10.\n\nT_boil_val = 373.15\np_std_val = 101325.0  # Pa\n\nT_sat_range = 273:1:373\n\nfunction calc_p_sat(T)\n    a = 1 - T_boil_val / T\n    return p_std_val * exp(13.3185 * a - 1.9760 * a^2 - 0.6445 * a^3 - 0.1299 * a^4)\nend\n\np_sat_values = [calc_p_sat(T) for T in T_sat_range]\n\n# Reference values\nT_ref = [273.15, 283.15, 293.15, 298.15, 303.15, 313.15, 323.15, 373.15]\np_sat_ref = [611, 1228, 2338, 3168, 4245, 7378, 12349, 101325]  # Pa\n\np3 = plot(\n    T_sat_range, p_sat_values ./ 1000;\n    xlabel = \"Temperature (K)\",\n    ylabel = \"Saturation Vapor Pressure (kPa)\",\n    title = \"Saturation Vapor Pressure of Water (Eq. 1.10)\",\n    legend = :topleft,\n    linewidth = 2,\n    color = :blue,\n    label = \"Eq. 1.10\",\n    size = (600, 400),\n    grid = true\n)\n\nscatter!(p3, T_ref, p_sat_ref ./ 1000;\n    markersize = 8,\n    color = :red,\n    label = \"Reference values\")\n\np3","category":"section"},{"location":"seinfeld_pandis_ch1/#Saturation-Vapor-Pressure-Table","page":"Atmospheric Fundamentals","title":"Saturation Vapor Pressure Table","text":"T_table = [273.15, 278.15, 283.15, 288.15, 293.15, 298.15, 303.15, 308.15, 313.15, 373.15]\np_sat_calc = [calc_p_sat(T) for T in T_table]\n\nDataFrame(\n    :T_Celsius => round.(T_table .- 273.15, digits = 1),\n    :T_Kelvin => round.(T_table, digits = 2),\n    :p_sat_Pa => round.(p_sat_calc, digits = 1),\n    :p_sat_mbar => round.(p_sat_calc ./ 100, digits = 2)\n)\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Total-Molar-Concentration-(Figure)","page":"Atmospheric Fundamentals","title":"Total Molar Concentration (Figure)","text":"The total molar concentration depends on pressure and temperature through the ideal gas law (Eq. 1.7).\n\nT_conc_range = 250:5:320\nc_total_values = [p_0_val / (R_val * T) for T in T_conc_range]\n\np4 = plot(\n    T_conc_range, c_total_values;\n    xlabel = \"Temperature (K)\",\n    ylabel = \"Total Molar Concentration (mol/m^3)\",\n    title = \"Total Molar Concentration at p = 101325 Pa (Eq. 1.7)\",\n    legend = false,\n    linewidth = 2,\n    color = :blue,\n    size = (600, 400),\n    grid = true\n)\n\nscatter!(p4, [273.15, 298.15],\n    [p_0_val / (R_val * 273.15), p_0_val / (R_val * 298.15)];\n    markersize = 10,\n    color = :red)\n\nannotate!(p4, 273.15, 46.5, text(\"STP\\n(44.6 mol/m^3)\", 8, :center))\nannotate!(p4, 298.15, 39.0, text(\"Room temp\\n(40.9 mol/m^3)\", 8, :center))\n\np4\n\n","category":"section"},{"location":"seinfeld_pandis_ch1/#Atmospheric-Profile-Summary-(Figure)","page":"Atmospheric Fundamentals","title":"Atmospheric Profile Summary (Figure)","text":"This figure summarizes the vertical structure of the atmosphere using data from Table 1.4.\n\naltitudes = [0, 5, 10, 15, 20, 25, 30, 40, 50]\ntemperatures = [288.2, 255.7, 223.3, 216.7, 216.7, 221.6, 226.5, 250.4, 270.7]\npressures = [1013.0, 540.5, 265.0, 121.1, 55.29, 25.49, 11.97, 2.871, 0.798]\ndensities = [1.225, 0.736, 0.414, 0.195, 0.0889, 0.0401, 0.0184, 0.00400, 0.00103]\n\nl = @layout [a b c]\n\np_temp = plot(temperatures, altitudes;\n    xlabel = \"Temperature (K)\",\n    ylabel = \"Altitude (km)\",\n    title = \"Temperature\",\n    linewidth = 2,\n    marker = :circle,\n    color = :red,\n    legend = false,\n    xlims = (200, 300))\n\nhline!(p_temp, [11]; color = :gray, linestyle = :dash, label = nothing)\nannotate!(p_temp, 250, 5, text(\"Troposphere\", 8, :center))\nannotate!(p_temp, 250, 25, text(\"Stratosphere\", 8, :center))\n\np_press = plot(pressures, altitudes;\n    xlabel = \"Pressure (mbar)\",\n    ylabel = \"Altitude (km)\",\n    title = \"Pressure\",\n    linewidth = 2,\n    marker = :circle,\n    color = :blue,\n    xscale = :log10,\n    legend = false)\n\np_dens = plot(densities, altitudes;\n    xlabel = \"Density (kg/m^3)\",\n    ylabel = \"Altitude (km)\",\n    title = \"Density\",\n    linewidth = 2,\n    marker = :circle,\n    color = :green,\n    xscale = :log10,\n    legend = false)\n\nplot(p_temp, p_press, p_dens;\n    layout = l,\n    size = (900, 400),\n    plot_title = \"U.S. Standard Atmosphere (Table 1.4)\")","category":"section"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.IdealGasLaw","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.IdealGasLaw","text":"IdealGasLaw(; name=:IdealGasLaw)\n\nCalculates air density from pressure and temperature using the ideal gas law.\n\nImplements Equation 1.2: rho = M_air * p / (R * T)\n\nwhere:\n\nrho: air density (kg/m^3)\nM_air: molecular weight of dry air (kg/mol)\np: atmospheric pressure (Pa)\nR: universal gas constant (J/(mol*K))\nT: temperature (K)\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.ScaleHeight","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.ScaleHeight","text":"ScaleHeight(; name=:ScaleHeight)\n\nCalculates the atmospheric scale height.\n\nImplements Equation 1.4: H = R * T / (M_air * g)\n\nThe scale height H represents the altitude increase over which pressure decreases by a factor of e (~2.718).\n\nTypical values:\n\nAt T = 253 K: H = 7.4 km\nAt T = 288 K (sea level): H = 8.4 km\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.AtmosphericPressureProfile","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.AtmosphericPressureProfile","text":"AtmosphericPressureProfile(; name=:AtmosphericPressureProfile)\n\nCalculates atmospheric pressure as a function of altitude for an isothermal atmosphere.\n\nImplements:\n\nEquation 1.1: dp/dz = -rho * g (hydrostatic equation)\nEquation 1.3: dp/dz = -M_air * g * p / (R * T) (combined form)\nEquation 1.5: p(z)/p_0 = exp(-z/H) (barometric formula, isothermal case)\n\nThis component uses the barometric formula (Eq. 1.5) which is the integrated form of the hydrostatic equation for an isothermal atmosphere.\n\nNote: For a non-isothermal atmosphere, the scale height varies with altitude and numerical integration of Eq. 1.3 would be required.\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.BarometricFormula","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.BarometricFormula","text":"BarometricFormula(; name=:BarometricFormula)\n\nCalculates pressure at a given altitude using the barometric formula.\n\nImplements Equation 1.5: p(z) = p_0 * exp(-z/H)\n\nThis is the integrated form of the hydrostatic equation for an isothermal atmosphere. The scale height H is provided as an input.\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.TotalMolarConcentration","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.TotalMolarConcentration","text":"TotalMolarConcentration(; name=:TotalMolarConcentration)\n\nCalculates total molar concentration of air from pressure and temperature.\n\nImplements Equation 1.7: c_total = N/V = p / (R * T)\n\nStandard values:\n\nAt STP (T=273.15 K, p=101325 Pa): c_total = 44.6 mol/m^3\nAt T=298 K, p=101325 Pa: c_total = 40.9 mol/m^3\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.MixingRatio","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.MixingRatio","text":"MixingRatio(; name=:MixingRatio)\n\nCalculates the volume (mole) mixing ratio of a species.\n\nImplements Equation 1.6: xii = ci / c_total\n\nThe mixing ratio is dimensionless and typically expressed in ppm, ppb, or ppt.\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.PartialPressureMixingRatio","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.PartialPressureMixingRatio","text":"PartialPressureMixingRatio(; name=:PartialPressureMixingRatio)\n\nRelates mixing ratio to partial pressure.\n\nImplements Equation 1.8: xii = ci / (p/(R*T)) = p_i / p\n\nThe mixing ratio equals the ratio of partial pressure to total pressure.\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.SaturationVaporPressure","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.SaturationVaporPressure","text":"SaturationVaporPressure(; name=:SaturationVaporPressure)\n\nCalculates the saturation vapor pressure of water as a function of temperature.\n\nImplements Equation 1.10: pH2Osat(T) = 1013.25 * exp(13.3185a - 1.9760a^2 - 0.6445a^3 - 0.1299a^4)\n\nwhere: a = 1 - 373.15/T\n\nThis empirical formula is valid for liquid water (T > 273 K).\n\nNote: The original equation gives pressure in mbar. Here we convert to Pa for consistency with SI units: psat (Pa) = 100 * psat (mbar)\n\nReference values:\n\nAt T = 273 K: p_sat ~ 611 Pa (6.1 mbar)\nAt T = 298 K: p_sat ~ 3170 Pa (31.7 mbar)\nAt T = 373 K: p_sat = 101325 Pa (1013.25 mbar, boiling point)\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.RelativeHumidity","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.RelativeHumidity","text":"RelativeHumidity(; name=:RelativeHumidity)\n\nCalculates relative humidity from water vapor partial pressure and saturation vapor pressure.\n\nImplements Equation 1.9: RH = 100 * pH2O / pH2O_sat\n\nRelative humidity is expressed as a percentage (0-100%), stored as a dimensionless ratio multiplied by 100.\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.AtmosphericThermodynamics","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.AtmosphericThermodynamics","text":"AtmosphericThermodynamics(; name=:AtmosphericThermodynamics)\n\nComplete atmospheric thermodynamics system combining:\n\nEquation 1.2: Ideal gas law for density\nEquation 1.4: Scale height\nEquation 1.5: Barometric formula\nEquation 1.7: Total molar concentration\n\nThis composite system calculates pressure, density, scale height, and total molar concentration given altitude and temperature for an isothermal atmosphere.\n\n\n\n\n\n","category":"function"},{"location":"seinfeld_pandis_ch1/#EnvironmentalTransport.WaterVaporThermodynamics","page":"Atmospheric Fundamentals","title":"EnvironmentalTransport.WaterVaporThermodynamics","text":"WaterVaporThermodynamics(; name=:WaterVaporThermodynamics)\n\nComplete water vapor thermodynamics system combining:\n\nEquation 1.10: Saturation vapor pressure\nEquation 1.9: Relative humidity\n\nThis composite system calculates relative humidity given temperature and water vapor partial pressure.\n\n\n\n\n\n","category":"function"},{"location":"#EnvironmentalTransport:-Algorithms-for-Environmental-Mass-Transport","page":"Home","title":"EnvironmentalTransport: Algorithms for Environmental Mass Transport","text":"Documentation for EnvironmentalTransport.jl.\n\nThis package contains algorithms for simulating environmental mass transport, for use with the EarthSciML ecosystem.","category":"section"},{"location":"#Installation","page":"Home","title":"Installation","text":"using Pkg\nPkg.add(\"EnvironmentalTransport\")","category":"section"},{"location":"#Feature-Summary","page":"Home","title":"Feature Summary","text":"This package contains types and functions designed to simplify the process of constructing and composing symbolically-defined Earth Science model components together.","category":"section"},{"location":"#Feature-List","page":"Home","title":"Feature List","text":"Numerical Advection","category":"section"},{"location":"#Contributing","page":"Home","title":"Contributing","text":"Please refer to the SciML ColPrac: Contributor's Guide on Collaborative Practices for Community Packages for guidance on PRs, issues, and other matters relating to contributing.","category":"section"},{"location":"#Reproducibility","page":"Home","title":"Reproducibility","text":"<details><summary>The documentation of this EnvironmentalTransport package was built using these direct dependencies,</summary>\n\nusing Pkg # hide\nPkg.status() # hide\n\n</details>\n\n<details><summary>and using this machine and Julia version.</summary>\n\nusing InteractiveUtils # hide\nversioninfo() # hide\n\n</details>\n\n<details><summary>A more complete overview of all dependencies and their versions is also provided.</summary>\n\nusing Pkg # hide\nPkg.status(; mode = PKGMODE_MANIFEST) # hide\n\n</details>\n\nYou can also download the \n<a href=\"\n\nusing TOML\nusing Markdown\nversion = TOML.parse(read(\"../../Project.toml\", String))[\"version\"]\nname = TOML.parse(read(\"../../Project.toml\", String))[\"name\"]\nlink = Markdown.MD(\"https://github.com/EarthSciML/\"*name*\".jl/tree/gh-pages/v\"*version*\"/assets/Manifest.toml\")\n\n\">manifest</a> file and the\n<a href=\"\n\nusing TOML\nusing Markdown\nversion = TOML.parse(read(\"../../Project.toml\", String))[\"version\"]\nname = TOML.parse(read(\"../../Project.toml\", String))[\"name\"]\nlink = Markdown.MD(\"https://github.com/EarthSciML/\"*name*\".jl/tree/gh-pages/v\"*version*\"/assets/Project.toml\")\n\n\">project</a> file.","category":"section"},{"location":"advection/#Numerical-Advection-Operator","page":"Advection","title":"Numerical Advection Operator","text":"We have two ways to represent phenomena that occur across space such as advection: through symbolically-defined partial differential equation systems, which will be covered elsewhere in documentation, and through numerically-implemented algorithms. This is an example of the latter. (Currently, symbolically defined PDEs are too slow to be used in large-scale simulations.)\n\nTo demonstrate how it works, let's first set up our environment:\n\nusing EnvironmentalTransport\nusing EarthSciMLBase, EarthSciData\nusing ModelingToolkit, DifferentialEquations\nusing ProgressLogging\nusing ModelingToolkit: t, D\nusing DynamicQuantities\nusing Distributions, LinearAlgebra\nusing Dates\nusing NCDatasets, Plots\nnothing #hide","category":"section"},{"location":"advection/#Emissions","page":"Advection","title":"Emissions","text":"Next, let's set up an emissions scenario to advect. We'll make the emissions start at the beginning of the simulation and then taper off:\n\nstarttime = DateTime(2022, 5, 1)\nendtime = DateTime(2022, 5, 10)\n\nstruct EmissionsCoupler\n    sys\nend\nfunction emissions(Î¼_lon, Î¼_lat, Ïƒ)\n    @parameters(lon=-97.0, [unit=u\"rad\"],\n        lat=30.0, [unit=u\"rad\"],\n        lev=1.0,)\n    @variables c(t) = 0.0 [unit=u\"kg\"]\n    @constants v_emis = 50.0 [unit=u\"kg/s\"]\n    @constants t_unit = 1.0 [unit=u\"s\"] # Needed so that arguments to `pdf` are unitless.\n    dist = MvNormal([datetime2unix(starttime), Î¼_lon, Î¼_lat, 1],\n        Diagonal(map(abs2, [3600.0*24*3, Ïƒ, Ïƒ, 1])))\n    ODESystem([D(c) ~ pdf(dist, [t/t_unit, lon, lat, lev]) * v_emis],\n        t, name = :emissions, metadata = Dict(CoupleType => EmissionsCoupler))\nend\nfunction EarthSciMLBase.couple2(e::EmissionsCoupler, g::EarthSciData.GEOSFPCoupler)\n    e, g = e.sys, g.sys\n    e = param_to_var(e, :lat, :lon, :lev)\n    ConnectorSystem([e.lat ~ g.lat, e.lon ~ g.lon, e.lev ~ g.lev], e, g)\nend\n\nemis = emissions(deg2rad(-97.0), deg2rad(40.0), deg2rad(1))","category":"section"},{"location":"advection/#Coupled-System","page":"Advection","title":"Coupled System","text":"Next, let's set up a spatial and temporal domain for our simulation, and some input data from GEOS-FP to get wind fields for our advection. We need to use coord_defaults in this case to get the GEOS-FP data to work correctly, but it doesn't matter what the defaults are. We also set up an outputter to save the results of our simulation, and couple the components we've created so far into a single system.\n\n\ndomain = DomainInfo(\n    starttime, endtime;\n    lonrange = deg2rad(-115):deg2rad(1):deg2rad(-68.75),\n    latrange = deg2rad(25):deg2rad(1):deg2rad(53.7),\n    levrange = 1:1:15)\n\ngeosfp = GEOSFP(\"4x5\", domain)\ngeosfp = EarthSciMLBase.copy_with_change(geosfp, discrete_events = []) # Workaround for bug.\n\noutfile = (\"RUNNER_TEMP\" âˆˆ keys(ENV) ? ENV[\"RUNNER_TEMP\"] : tempname()) * \"out.nc\" # This is just a location to save the output.\noutput = NetCDFOutputter(outfile, 3600.0)\n\ncsys = couple(emis, domain, geosfp, output)","category":"section"},{"location":"advection/#Advection-Operator","page":"Advection","title":"Advection Operator","text":"Next, we create an AdvectionOperator to perform advection. We need to specify a time step (300 s in this case), as stencil algorithm to do the advection (current options are upwind1_stencil). We also specify zero gradient boundary conditions.\n\nThen, we couple the advection operator to the rest of the system.\n\nadv = AdvectionOperator(300.0, upwind1_stencil, ZeroGradBC())\n\ncsys = couple(csys, adv)\n\nNow, we initialize a ODEProblem to run our demonstration. We use the Tsit5 time integrator for our emissions system of equations, and a time integration scheme for our advection operator (SSPRK22 in this case). Refer here for the available time integrator choices. We also choose a operator splitting interval of 300 seconds. Then, we run the simulation.\n\nst = SolverStrangSerial(Tsit5(), 300.0)\nprob = ODEProblem(csys, st)\n\n@time solve(\n    prob, SSPRK22(), dt = 300, save_on = false, save_start = false, save_end = false,\n    initialize_save = false, progress = true, progress_steps = 1)","category":"section"},{"location":"advection/#Visualization","page":"Advection","title":"Visualization","text":"Finally, we can visualize the results of our simulation:\n\nds = NCDataset(outfile, \"r\")\n\nimax = argmax(reshape(maximum(ds[\"emissionsâ‚Šc\"][:, :, :, :], dims = (1, 3, 4)), :))\ngrid = EarthSciMLBase.grid(domain)\nanim = @animate for i in 1:size(ds[\"emissionsâ‚Šc\"])[4]\n    plot(\n        heatmap(rad2deg.(grid[1]), rad2deg.(grid[2]),\n            ds[\"emissionsâ‚Šc\"][:, :, 1, i]', title = \"Ground-Level\", xlabel = \"Longitude\", ylabel = \"Latitude\"),\n        heatmap(rad2deg.(grid[1]), grid[3], ds[\"emissionsâ‚Šc\"][:, imax, :, i]',\n            title = \"Vertical Cross-Section (lat=$(round(rad2deg(grid[2][imax]), digits=1)))\",\n            xlabel = \"Longitude\", ylabel = \"Vertical Level\"),\n        size = (1200, 400)\n    )\nend\ngif(anim, fps = 15)","category":"section"}]
}
